<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/admin/dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <body>
        <div class="dashboard-container">

            <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
            <%- include('../partials/sidebar', {activePage: 'dashboard' }) %>
                <main class="main-content">

                    <header class="main-header">
                        <div class="header-title">
                            <h2>Dashboard</h2>
                            <p>Welcome back, Admin! Here's what's happening today.</p>
                        </div>
                    </header>

                    <section class="stats-cards">
                        <div class="stat-card">
                            <div class="card-icon revenue-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                            </div>
                            <div class="card-info">
                                <span class="card-title">Total Revenue</span>
                                <span class="card-value" id="stat-revenue">â‚¹<%= summary.totalSales ?
                                        Number(summary.totalSales.toFixed(2)).toLocaleString('en-IN') : '0.00' %></span>
                                <span class="card-change positive">Revenue based on current filter</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="card-icon orders-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                                    <polyline points="13 2 13 9 20 9"></polyline>
                                </svg>
                            </div>
                            <div class="card-info">
                                <span class="card-title">Total Orders</span>
                                <span class="card-value" id="stat-orders">
                                    <%= summary.totalOrders %>
                                </span>
                                <span class="card-change positive">Orders based on current filter</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="card-icon sales-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 20V10"></path>
                                    <path d="M18 20V4"></path>
                                    <path d="M6 20V16"></path>
                                </svg>
                            </div>
                            <div class="card-info">
                                <span class="card-title">Total Discount</span>
                                <span class="card-value" id="stat-discount">â‚¹<%= summary.totalDiscount ?
                                        Number(summary.totalDiscount.toFixed(2)).toLocaleString('en-IN') : '0.00' %>
                                        </span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="card-icon users-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                            </div>
                            <div class="card-info">
                                <span class="card-title">Active Users</span>
                                <span class="card-value" id="stat-active-users">
                                    <%= activeUser %>
                                </span>
                            </div>
                        </div>
                    </section>

                    <section class="dashboard-row">
                        <div class="sales-overview card">
                            <div class="card-header">
                                <h3>Sales Overview</h3>
                                <div class="tabs">
                                    <button class="tab-btn active"
                                        onclick="updateChart(this, 'monthly')">Monthly</button>
                                    <button class="tab-btn" onclick="updateChart(this, 'yearly')">Yearly</button>
                                    <button class="tab-btn" onclick="updateChart(this, 'weekly')">Weekly</button>
                                    <button class="tab-btn active" onclick="updateChart(this, 'daily')">Daily</button>
                                </div>
                            </div>
                            <div class="chart-placeholder" style="position: relative; height: 300px; width: 100%;">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>

                        <div class="order-status-card card">
                            <div class="card-header">
                                <h3>Order Status</h3>
                            </div>

                            <div class="chart-container"
                                style="position: relative; height: 250px; display: flex; justify-content: center; align-items: center;">
                                <canvas id="statusChart"></canvas>

                                <div id="chartCenterText"
                                    style="position: absolute; text-align: center; pointer-events: none;">
                                    <span id="centerCount"
                                        style="display: block; font-size: 2rem; font-weight: bold; color: #333;">0</span>
                                    <span style="font-size: 0.9rem; color: #888;">Orders</span>
                                </div>
                            </div>

                            <div id="statusLegend"
                                style="margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;">
                            </div>
                        </div>
                    </section>

                    <section class="orders-table card">
                        <div class="card-header">
                            <div class="tabs">
                                <button class="tab-btn active" onclick="switchTable('recent-orders', this)">Recent
                                    Orders</button>
                                <button class="tab-btn" onclick="switchTable('top-products', this)">Top
                                    Products</button>
                                <button class="tab-btn" onclick="switchTable('top-categories', this)">Top
                                    Categories</button>
                                <button class="tab-btn" onclick="switchTable('top-brands', this)">Top Brands</button>
                            </div>
                        </div>

                        <div id="recent-orders" class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="table-recent-orders-body">
                                    <% if (orders && orders.length> 0) { %>
                                        <% orders.forEach(order=> { %>
                                            <tr>
                                                <td>#<%= order.orderId %>
                                                </td>
                                                <td>
                                                    <%= order.customerName %>
                                                </td>
                                                <td>
                                                    <%= new Date(order.date).toLocaleDateString() %>
                                                </td>
                                                <td><span class="status completed">Completed</span></td>
                                                <td>â‚¹<%= order.rowTotal.toFixed(2) %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="5">No orders found.</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                            <a href="/admin/sales" class="view-all-link">View Full Report</a>
                        </div>

                        <div id="top-products" class="table-container" style="display: none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Product</th>
                                        <th>Units Sold</th>
                                        <th>Revenue</th>
                                    </tr>
                                </thead>
                                <tbody id="table-top-products-body">
                                    <% if (topProducts && topProducts.length> 0) { %>
                                        <% topProducts.forEach((item, index)=> { %>
                                            <tr>
                                                <td>#<%= index + 1 %>
                                                </td>
                                                <td>
                                                    <div class="product-name-cell">
                                                        <img src="<%= item.productImage %>" alt="Product"
                                                            class="product-thumbnail"
                                                            onerror="this.src='/images/default-product.jpg'"> <span>
                                                            <%= item._id %>
                                                        </span>
                                                    </div>
                                                </td>
                                                <td>
                                                    <%= item.totalSold %>
                                                </td>
                                                <td>â‚¹<%= item.totalRevenue.toFixed(2) %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="4">No data available.</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <div id="top-categories" class="table-container" style="display: none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Category Name</th>
                                        <th>Units Sold</th>
                                    </tr>
                                </thead>
                                <tbody id="table-top-categories-body">
                                    <% if (topCategories && topCategories.length> 0) { %>
                                        <% topCategories.forEach((item, index)=> { %>
                                            <tr style="height: 50px;">
                                                <td>#<%= index + 1 %>
                                                </td>
                                                <td>
                                                    <%= item._id %>
                                                </td>
                                                <td>
                                                    <%= item.totalSold %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="3">No data available.</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>

                        <div id="top-brands" class="table-container" style="display: none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Brand Name</th>
                                        <th>Units Sold</th>
                                    </tr>
                                </thead>
                                <tbody id="table-top-brands-body">
                                    <% if (topBrands && topBrands.length> 0) { %>
                                        <% topBrands.forEach((item, index)=> { %>
                                            <tr>
                                                <td>#<%= index + 1 %>
                                                </td>
                                                <td>
                                                    <div class="brand-name-cell">
                                                        <img src="<%= item.brandImage %>" alt="brand"
                                                            class="brand-thumbnail"
                                                            onerror="this.src='/images/default-product.jpg'"> <span>
                                                            <%= item._id %>
                                                        </span>
                                                    </div>
                                                <td>
                                                    <%= item.totalSold %>
                                                </td>
                                            </tr>
                                            <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="3">No data available.</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </section>

                </main>
        </div>

        <%- include('../partials/footer') %>

            <script src="/js/axios.min.js"></script>

            <script>
                let salesChart;
                let statusChart; // Global variable for status chart

                document.addEventListener("DOMContentLoaded", function () {
                    // --- 1. Initialize Sales Chart ---
                    const ctx = document.getElementById('salesChart').getContext('2d');
                    const initialData = <%- JSON.stringify(chartData || []) %>;

                    salesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: initialData.map(item => item._id),
                            datasets: [{
                                label: 'Revenue (â‚¹)',
                                data: initialData.map(item => item.totalSales),
                                borderColor: '#007BFF',
                                backgroundColor: createGradient(ctx),
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#007BFF',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, ticks: { callback: (val) => 'â‚¹' + val } },
                                x: { grid: { display: false } }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });

                    // --- 2. Initialize Status Chart ---
                    initStatusChart();
                });

                // Helper: Gradient
                function createGradient(ctx) {
                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                    gradient.addColorStop(0, 'rgba(0, 123, 255, 0.2)');
                    gradient.addColorStop(1, 'rgba(0, 123, 255, 0.0)');
                    return gradient;
                }

                // --- 3. Initialize Status Donut Chart ---
                function initStatusChart() {
                    const statusRaw = <%- JSON.stringify(orderStatusData || []) %>;
                    renderStatusChart(statusRaw);
                }

                function renderStatusChart(data) {
                    const statusLabels = data.map(item => item._id);
                    const statusCounts = data.map(item => item.count);
                    const totalStatusCount = statusCounts.reduce((a, b) => a + b, 0);

                    // Update Center Text
                    document.getElementById('centerCount').innerText = totalStatusCount;

                    // Colors
                    const statusColors = {
                        'Delivered': '#4caf50', 'Pending': '#ff9800', 'Shipped': '#2196f3',
                        'Cancelled': '#f44336', 'Returned': '#9c27b0', 'Return Rejected': '#607d8b',
                        'Confirmed': '#00bcd4', 'Processing': 'yellow', 'Return Request': '#8f0445'
                    };
                    const bgColors = statusLabels.map(label => statusColors[label] || '#ccc');

                    const ctx = document.getElementById('statusChart').getContext('2d');

                    // Destroy existing chart if updating
                    if (statusChart) {
                        statusChart.destroy();
                    }

                    statusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: statusLabels,
                            datasets: [{
                                data: statusCounts,
                                backgroundColor: bgColors,
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: { legend: { display: false } }
                        }
                    });

                    // Update Legend HTML
                    const legendContainer = document.getElementById('statusLegend');
                    legendContainer.innerHTML = '';
                    statusLabels.forEach((label, index) => {
                        const html = `
                <div style="display: flex; align-items: center; font-size: 0.85rem; color: #555;">
                    <span style="width: 10px; height: 10px; background-color: ${bgColors[index]}; border-radius: 50%; display: inline-block; margin-right: 6px;"></span>
                    ${label}
                </div>`;
                        legendContainer.innerHTML += html;
                    });
                }

                // ============================================
                // ðŸš€ MAIN UPDATE FUNCTION (Linked to Buttons)
                // ============================================
                async function updateChart(btn, filterType) {
                    Loading.show("Loading Dashboard...");
                    // 1. Update UI Buttons
                    document.querySelectorAll('.sales-overview .tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    try {
                        // 2. Fetch Data from the NEW API Endpoint
                        const response = await axios.get(`/admin/dashboard-filter`, {
                            params: { filter: filterType }
                        });

                        if (response.data.success) {
                            const data = response.data.data;

                            // A. Update Stats Cards
                            document.getElementById('stat-revenue').innerText = 'â‚¹' + data.summary.totalSales.toLocaleString('en-IN');
                            document.getElementById('stat-orders').innerText = data.summary.totalOrders;
                            document.getElementById('stat-discount').innerText = 'â‚¹' + data.summary.totalDiscount.toLocaleString('en-IN');

                            // B. Update Sales Chart
                            salesChart.data.labels = data.chartData.map(item => item._id);
                            salesChart.data.datasets[0].data = data.chartData.map(item => item.totalSales);
                            salesChart.update();

                            // C. Update Status Chart
                            renderStatusChart(data.orderStatusData);

                            // D. Update Tables
                            updateRecentOrdersTable(data.orders);
                            updateTopProductsTable(data.topProducts);
                            updateTopCategoriesTable(data.topCategories);
                            updateTopBrandsTable(data.topBrands);
                        }

                    } catch (error) {
                        console.error("Error updating dashboard:", error);
                        // Optional: Show a toast notification here
                    } finally {
                        // 2. Hide Loader (Always runs, success or error)
                        Loading.hide();
                    }

                }

                // --- Table HTML Generators ---

                function updateRecentOrdersTable(orders) {
                    const tbody = document.getElementById('table-recent-orders-body');
                    tbody.innerHTML = ''; // Clear current rows

                    if (!orders || orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5">No orders found.</td></tr>';
                        return;
                    }

                    orders.forEach(order => {
                        const row = `
                <tr>
                    <td>#${order.orderId}</td>
                    <td>${order.customerName}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td><span class="status completed">Completed</span></td>
                    <td>â‚¹${order.rowTotal.toFixed(2)}</td>
                </tr>`;
                        tbody.innerHTML += row;
                    });
                }

                function updateTopProductsTable(products) {
                    const tbody = document.getElementById('table-top-products-body');
                    tbody.innerHTML = '';

                    if (!products || products.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">No data available.</td></tr>';
                        return;
                    }

                    products.forEach((item, index) => {
                        const row = `
                <tr>
                    <td>#${index + 1}</td>
                    <td>
                        <div class="product-name-cell">
                            <img src="${item.productImage}" class="product-thumbnail" onerror="this.src='/images/default-product.jpg'">
                            <span>${item._id}</span>
                        </div>
                    </td>
                    <td>${item.totalSold}</td>
                    <td>â‚¹${item.totalRevenue.toFixed(2)}</td>
                </tr>`;
                        tbody.innerHTML += row;
                    });
                }

                function updateTopCategoriesTable(categories) {
                    const tbody = document.getElementById('table-top-categories-body');
                    tbody.innerHTML = '';

                    if (!categories || categories.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">No data available.</td></tr>';
                        return;
                    }

                    categories.forEach((item, index) => {
                        const row = `
                <tr style="height: 50px;">
                    <td>#${index + 1}</td>
                    <td>${item._id}</td>
                    <td>${item.totalSold}</td>
                </tr>`;
                        tbody.innerHTML += row;
                    });
                }

                function updateTopBrandsTable(brands) {
                    const tbody = document.getElementById('table-top-brands-body');
                    tbody.innerHTML = '';

                    if (!brands || brands.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3">No data available.</td></tr>';
                        return;
                    }

                    brands.forEach((item, index) => {
                        const row = `
                <tr>
                    <td>#${index + 1}</td>
                    <td>
                        <div class="brand-name-cell">
                            <img src="${item.brandImage}" class="brand-thumbnail" onerror="this.src='/images/default-product.jpg'">
                            <span>${item._id}</span>
                        </div>
                    </td>
                    <td>${item.totalSold}</td>
                </tr>`;
                        tbody.innerHTML += row;
                    });
                }


            </script>