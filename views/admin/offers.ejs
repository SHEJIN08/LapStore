<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/admin/offer.css">
</head>
<body>

    <div class="app-container">
        <%- include('../partials/sidebar', { activePage: 'offers' }) %>
        
        <main class="main-content">
            <header class="page-header">
                <div class="header-text">
                    <h1>Offer Management</h1>
                    <p>Create and manage offers for your products.</p>
                </div>
                <button class="btn-primary" onclick="openOfferModal()">+ Add New Offer</button>
            </header>

            <section class="stats-grid">
                <div class="stat-card">
                    <h3>Active offers</h3>
                    <div class="stat-value"><%= stats ? stats.active : 0 %></div>
                </div>
                <div class="stat-card">
                    <h3>Blocked offers</h3>
                    <div class="stat-value"><%= stats ? stats.inactive : 0 %></div>
                </div>
                <div class="stat-card">
                    <h3>Expired Offers</h3>
                    <div class="stat-value"><%= stats ? stats.expired : 0 %></div>
                </div>
                <div class="stat-card">
                    <h3>Most Used Offers</h3>
                    <div class="stat-value" style="color: #2563eb; font-size: 18px;">
                        <%= stats ? stats.mostUsed : 'N/A' %>
                    </div>
                </div>
            </section>

            <section class="filter-section">
                <form action="/admin/offers" method="GET" style="display: flex; width: 100%; justify-content: space-between;">
                    <div class="search-wrapper">
                        <input type="text" name="search" placeholder="Search by name..." class="search-input" value="<%= locals.currentSearch || '' %>">
                    </div>
                    <div class="filter-controls">
                        <select name="status" class="status-select" onchange="this.form.submit()">
                            <option value="All Statuses" <%= currentStatus === 'All Statuses' ? 'selected' : '' %>>All Statuses</option>
                            <option value="Active" <%= currentStatus === 'Active' ? 'selected' : '' %>>Active</option>
                            <option value="Expired" <%= currentStatus === 'Expired' ? 'selected' : '' %>>Expired</option>
                            <option value="Inactive" <%= currentStatus === 'Inactive' ? 'selected' : '' %>>Inactive</option>
                        </select>
                        <button type="button" class="btn-primary" style="margin:0;" onclick="openOfferModal()">+ Add Offer</button>
                    </div>
                </form>
            </section>

            <section class="table-section">
                <h2 style="margin-left: 10px; padding-top:10px;">All offers</h2>
                
                <div class="table-responsive">
                    <table class="coupon-table">
                        <thead>
                            <tr>
                                <th>Offer Name</th>
                                <th>Type</th>
                                <th>Discount</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if(offers && offers.length > 0) { %>
                                <% offers.forEach(offer => { %>
                                    <tr>
                                        <td>
                                            <div class="coupon-info">
                                                <span class="code"><%= offer.offerName %></span>
                                                <span class="desc"><%= offer.offerType === 'product' ? 'Product Offer' : 'Category Offer' %></span>
                                            </div>
                                        </td>
                                        <td style="text-transform: capitalize;"><%= offer.discountType %></td>
                                        <td class="bold-text">
                                            <%= offer.discountType === 'percentage' ? offer.discountValue + '%' : '₹' + offer.discountValue %>
                                        </td>
                                        <td><%= new Date(offer.startDate).toLocaleDateString() %></td>
                                        <td><%= new Date(offer.endDate).toLocaleDateString() %></td>
                                        <td>
                                            <% 
                                                const now = new Date();
                                                const start = new Date(offer.startDate);
                                                const end = new Date(offer.endDate);
                                                let statusClass = 'inactive';
                                                let statusText = 'Inactive';

                                                if (!offer.isActive) {
                                                    statusClass = 'inactive';
                                                    statusText = 'Inactive';
                                                } else if (end < now) {
                                                    statusClass = 'expired';
                                                    statusText = 'Expired';
                                                } else {
                                                    statusClass = 'active';
                                                    statusText = 'Active';
                                                }
                                            %>
                                            <span class="badge <%= statusClass %>"><%= statusText %></span>
                                        </td>
                                        <td>
                                            <a href="javascript:void(0)" onclick="editOffer('<%= offer._id %>')" class="action-link">Edit</a>
                                            
                                           
                                        </td>
                                    </tr>
                                <% }) %>
                            <% } else { %>
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px;">No offers found matching your criteria.</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>

                <% if (totalPages > 1) { %>
                    <div class="pagination">
                        <span class="results-text">Page <%= currentPage %> of <%= totalPages %></span>
                        <div class="page-controls">
                            <% if (currentPage > 1) { %>
                                <a href="/admin/offers?page=<%= currentPage - 1 %>&search=<%= currentSearch %>&status=<%= currentStatus %>" class="page-btn">Previous</a>
                            <% } %>
                            
                            <% for(let i = 1; i <= totalPages; i++) { %>
                                <a href="/admin/offers?page=<%= i %>&search=<%= currentSearch %>&status=<%= currentStatus %>" 
                                   class="page-btn <%= currentPage === i ? 'active' : '' %>">
                                   <%= i %>
                                </a>
                            <% } %>

                            <% if (currentPage < totalPages) { %>
                                <a href="/admin/offers?page=<%= currentPage + 1 %>&search=<%= currentSearch %>&status=<%= currentStatus %>" class="page-btn">Next</a>
                            <% } %>
                        </div>
                    </div>
                <% } %>
            </section>
        </main>
    </div>

    <div id="addOfferModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Offer</h3>
                <button class="close-btn" onclick="closeOfferModal()">&times;</button>
            </div>

            <form id="addOfferForm">
                <input type="hidden" id="offerId" name="offerId">

                <section class="form-section">
                    <h4>Offer Details</h4>
                    <div class="form-group">
                        <label>Offer Name</label>
                        <input type="text" id="offerName" name="offerName" placeholder="e.g. Christmas Sale" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group half">
                            <label>Discount Type</label>
                            <select name="discountType" id="discountType">
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount (₹)</option>
                            </select>
                        </div>
                        <div class="form-group half">
                            <label>Discount Value</label>
                            <input type="number" id="discountValue" name="discountValue" placeholder="e.g. 15" required>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h4>Target Strategy</h4>
                    <div class="form-group">
                        <label>Offer Type</label>
                        <select name="offerType" id="offerTypeSelect">
                            <option value="product">Product Offer</option>
                            <option value="category">Category Offer</option>
                        </select>
                    </div>

                    <div class="form-group" id="categorySelectDiv" style="display: none;">
                        <label>Select Category</label>
                        <select id="categoryId" name="categoryId">
                            <option value="">-- Choose a Category --</option>
                            <% if(locals.categories && categories.length > 0) { %>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat._id %>"><%= cat.categoryName %></option>
                                <% }) %>
                            <% } else { %>
                                <option value="" disabled>No categories found</option>
                            <% } %>
                        </select>
                    </div>

                    <div class="form-group" id="productSearchDiv">
                        <label>Select Products</label>
                        <div class="search-box-wrapper">
                            <input type="text" id="productSearchInput" placeholder="Search product by name..." autocomplete="off">
                            <div id="productSearchResults" class="search-results-list"></div>
                        </div>
                        
                        <div id="selectedProductsContainer" class="selected-tags-area">
                            </div>
                    </div>
                </section>

                <section class="form-section">
                    <h4>Validity</h4>
                    <div class="form-row">
                        <div class="form-group half">
                            <label>Start Date</label>
                            <input type="date" id="startDate" name="startDate" required>
                        </div>
                        <div class="form-group half">
                            <label>End Date</label>
                            <input type="date" id="endDate" name="endDate" required>
                        </div>
                    </div>
                    <div class="form-group toggle-group">
                        <label>Status</label>
                        <div class="toggle-wrapper">
                            <span class="toggle-label">Inactive</span>
                            <label class="switch">
                                <input type="checkbox" id="status" name="status" checked>
                                <span class="slider round"></span>
                            </label>
                            <span class="toggle-label active">Active</span>
                        </div>
                    </div>
                </section>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeOfferModal()">Cancel</button>
                    <button type="submit" class="btn-save" id="submitBtn">Create Offer</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/axios.min.js"></script>

    
    <script>

         const showToast = (message, type) => {
                    const bgColor = type === 'success' ? "linear-gradient(to right, #30E527, #238500)" : "linear-gradient(to right, #e52d27, #b31217)";
                    Toastify({
                        text: message,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        style: { background: bgColor, borderRadius: '10px' }
                    }).showToast();
                };

        let selectedProducts = [];
        const modal = document.getElementById('addOfferModal');
        const form = document.getElementById('addOfferForm');

        // --- 1. MODAL CONTROLS ---
        function openOfferModal() {
            // Reset for "Add New" mode
            form.reset();
            document.getElementById('offerId').value = ''; 
            document.querySelector('.modal-header h3').innerText = 'Add New Offer';
            document.getElementById('submitBtn').innerText = 'Create Offer';
            
            selectedProducts = [];
            renderSelectedProducts();
            
            // Reset Views
            document.getElementById('productSearchDiv').style.display = 'block';
            document.getElementById('categorySelectDiv').style.display = 'none';
            
            modal.style.display = 'flex';
        }

        function closeOfferModal() {
            modal.style.display = 'none';
        }

        // --- 2. EDIT OFFER LOGIC ---
        async function editOffer(offerId) {
            try {

                const response = await axios.get(`/admin/offers/get/${offerId}`);
                if (!response.data.success) {
                    showToast(response.data.message, 'error')
                    return;
                }

                const offer = response.data.offer;

                // Populate Fields
                document.getElementById('offerId').value = offer._id;
                document.getElementById('offerName').value = offer.offerName;
                document.getElementById('discountType').value = offer.discountType;
                document.getElementById('discountValue').value = offer.discountValue;
                document.getElementById('status').checked = offer.isActive;

                // Format Dates (YYYY-MM-DD)
                if(offer.startDate) document.getElementById('startDate').value = new Date(offer.startDate).toISOString().split('T')[0];
                if(offer.endDate) document.getElementById('endDate').value = new Date(offer.endDate).toISOString().split('T')[0];

                // Handle Strategy (Product vs Category)
                const offerTypeSelect = document.getElementById('offerTypeSelect');
                offerTypeSelect.value = offer.offerType;

                if (offer.offerType === 'category') {
                    document.getElementById('productSearchDiv').style.display = 'none';
                    document.getElementById('categorySelectDiv').style.display = 'block';
                    document.getElementById('categoryId').value = offer.categoryId;
                    selectedProducts = [];
                } else {
                    document.getElementById('productSearchDiv').style.display = 'block';
                    document.getElementById('categorySelectDiv').style.display = 'none';
                    
                    // Backend must populate 'productIds'
                    if(offer.productIds && offer.productIds.length > 0) {
                        selectedProducts = offer.productIds.map(p => ({ id: p._id, name: p.name || 'Product' }));
                    } else {
                        selectedProducts = [];
                    }
                    renderSelectedProducts();
                }

                // Update UI for Edit Mode
                document.querySelector('.modal-header h3').innerText = 'Edit Offer';
                document.getElementById('submitBtn').innerText = 'Update Offer';
                
                modal.style.display = 'flex';

            } catch (error) {
                console.error(error);
                showToast( "Error fetching offer details", 'error')
            }
        }

        // --- 3. FORM SUBMISSION (Create & Edit) ---
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const offerId = document.getElementById('offerId').value;
            const offerType = document.getElementById('offerTypeSelect').value;
            const categoryId = document.getElementById('categoryId').value;

            // Validation
            if (offerType === 'product' && selectedProducts.length === 0) {
                showToast("Please select at least one product", 'error')
                return;
            }
            if (offerType === 'category' && !categoryId) {
                showToast("Please select a category", 'error')
                return;
            }

            const formData = {
                offerName: document.getElementById('offerName').value,
                offerType: offerType,
                discountType: document.getElementById('discountType').value,
                discountValue: document.getElementById('discountValue').value,
                categoryId: categoryId || null,
                productIds: selectedProducts.map(p => p.id),
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('status').checked
            };

            try {
                let response;
                if (offerId) {
                    // Update
                    response = await axios.put(`/admin/offers/edit/${offerId}`, formData);
                } else {
                    // Create
                    response = await axios.post('/admin/offers/create', formData);
                }

                if (response.data.success) {
                    showToast(offerId ? "Offer Updated!" : "Offer Created!", 'success')
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(response.data.message,'error')
                }
            } catch (error) {
                console.error(error);
                const msg = error.response?.data?.message || "Something went wrong";
                showToast(msg,"error")
            }
        });


        // --- 4. HELPER FUNCTIONS (Search, Render, Toggle) ---
        
        document.getElementById('offerTypeSelect').addEventListener('change', function() {
            if (this.value === 'category') {
                document.getElementById('productSearchDiv').style.display = 'none';
                document.getElementById('categorySelectDiv').style.display = 'block';
            } else {
                document.getElementById('productSearchDiv').style.display = 'block';
                document.getElementById('categorySelectDiv').style.display = 'none';
            }
        });

        const searchInput = document.getElementById('productSearchInput');
        const resultsList = document.getElementById('productSearchResults');
        let debounceTimer;

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim();
            clearTimeout(debounceTimer);
            
            if (query.length < 2) {
                resultsList.style.display = 'none';
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await axios.get(`/admin/products/search?search=${query}`);
                    const products = response.data.products || response.data; 

                    resultsList.innerHTML = '';
                    if (products && products.length > 0) {
                        products.forEach(p => {
                            if (selectedProducts.some(sp => sp.id === p._id)) return;
                            
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.innerText = p.name;
                            div.onclick = () => addProduct(p._id, p.name);
                            resultsList.appendChild(div);
                        });
                        resultsList.style.display = 'block';
                    } else {
                        resultsList.style.display = 'none';
                    }
                } catch (err) {
                    console.error(err);
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !resultsList.contains(e.target)) {
                resultsList.style.display = 'none';
            }
        });

        function addProduct(id, name) {
            selectedProducts.push({ id, name });
            renderSelectedProducts();
            searchInput.value = '';
            resultsList.style.display = 'none';
        }

        function removeProduct(id) {
            selectedProducts = selectedProducts.filter(p => p.id !== id);
            renderSelectedProducts();
        }

        function renderSelectedProducts() {
            const container = document.getElementById('selectedProductsContainer');
            container.innerHTML = '';
            selectedProducts.forEach(p => {
                const tag = document.createElement('div');
                tag.className = 'product-tag';
                tag.innerHTML = `${p.name} <span class="remove-tag" onclick="removeProduct('${p.id}')">&times;</span>`;
                container.appendChild(tag);
            });
        }
    </script>
</body>
</html>