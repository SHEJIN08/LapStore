<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/admin/bannerManagement.css">

<div class="admin-layout">
       <%- include('../partials/sidebar',{activePage: 'banners' }) %>

    <main class="main-content">
        <div class="page-header">
            <div class="header-text">
                <h1 class="page-title">Banner Management</h1>
                <p class="page-subtitle">Create and manage your home page banners.</p>
            </div>
            <button class="btn-add-banner" onclick="openAddModal()"> 
                <i class="fa-solid fa-plus"></i> Add New Banner
            </button>
        </div>

        <div class="table-container">
            <table class="banner-table">
                <thead>
                    <tr>
                        <th width="15%">Image</th>
                        <th width="25%">Title</th>
                        <th width="15%">Link / CTA</th>
                        <th width="15%">Status</th>
                        <th width="20%">Dates</th>
                        <th width="10%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (banners && banners.length > 0) { %>
                        <% banners.forEach(banner => { %>
                        <tr>
                            <td>
                                <div class="img-wrapper">
                                    <img src="<%= banner.image %>" alt="Banner" class="banner-thumb">
                                </div>
                            </td>
                            <td><span class="banner-title"><%= banner.title %></span></td>
                            <td><span class="banner-link"><%= banner.link %></span></td>
                            <td>
                                <% if (banner.isActive) { %>
                                    <span class="status-badge status-active"><span class="dot"></span> Active</span>
                                <% } else { %>
                                    <span class="status-badge status-inactive"><span class="dot"></span> Inactive</span>
                                <% } %>
                            </td>
                            <td>
                                <span class="date-text">
                                    <%= new Date(banner.startDate).toLocaleDateString('en-GB') %> - 
                                    <%= new Date(banner.endDate).toLocaleDateString('en-GB') %>
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon edit" 
                                        onclick="openEditModal(this)" 
                                        data-banner="<%= JSON.stringify(banner) %>">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% }) %>
                    <% } else { %>
                        <tr><td colspan="6" class="no-data">No banners found.</td></tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    </main>
</div>

<div id="bannerModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Banner</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="bannerForm" onsubmit="handleFormSubmit(event)">
            <input type="hidden" id="bannerId">

            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Banner Title</label>
                        <input type="text" name="title" id="inpTitle" required>
                    </div>
                    <div class="form-group">
                        <label>Subtitle</label>
                        <input type="text" name="description" id="inpDesc">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>CTA Text</label>
                        <input type="text" name="ctaText" id="inpCta" required>
                    </div>
                    <div class="form-group">
                        <label>CTA Link</label>
                        <input type="text" name="link" id="inpLink" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Banner Image</label>
                    <div class="upload-area" onclick="document.getElementById('bannerImage').click()">
                        <input type="file" id="bannerImage" name="image" accept="image/*" hidden onchange="previewImage(event)">
                        
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <p>Click to upload or drag and drop</p>
                        </div>
                        <img id="imgPreview" class="img-preview" style="display: none;">
                    </div>
                </div>

                <div class="form-row" style="align-items: center; justify-content: space-between; margin-top: 15px;">
                    <label style="margin:0; font-weight: 500;">Status</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="statusToggle" name="isActive" checked>
                        <label for="statusToggle" class="slider"></label>
                        <span class="toggle-label">Active</span>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Schedule</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="sub-label">Start Date</label>
                            <input type="date" name="startDate" id="inpStart" required>
                        </div>
                        <div class="form-group">
                            <label class="sub-label">End Date</label>
                            <input type="date" name="endDate" id="inpEnd" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn-save" id="btnSubmit">Save Banner</button>
            </div>
        </form>
    </div>
</div>
 <%- include('../partials/footer') %>    
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/axios.min.js"></script>

<script>
    // --- HELPER: Format Date for Input ---
    function formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toISOString().split('T')[0];
    }

    // --- 1. OPEN MODAL (ADD MODE) ---
    function openAddModal() {
        // Clear Form & ID
        document.getElementById('bannerForm').reset();
        document.getElementById('bannerId').value = ''; 
        
        // Reset UI Elements
        document.getElementById('modalTitle').innerText = 'Add New Banner';
        document.getElementById('btnSubmit').innerText = 'Save Banner';
        
        // Reset Image Preview
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('imgPreview').src = '';
        document.getElementById('uploadPlaceholder').style.display = 'flex';

        // Show Modal
        document.getElementById('bannerModal').style.display = 'flex';
    }

    // --- 2. OPEN MODAL (EDIT MODE) ---
    function openEditModal(button) {
        // Parse Data
        const banner = JSON.parse(button.getAttribute('data-banner'));

        // Fill Form Fields
        document.getElementById('bannerId').value = banner._id;
        document.getElementById('inpTitle').value = banner.title;
        document.getElementById('inpDesc').value = banner.description || '';
        document.getElementById('inpCta').value = banner.ctaText || '';
        document.getElementById('inpLink').value = banner.link;
        
        if (banner.startDate) document.getElementById('inpStart').value = formatDate(banner.startDate);
        if (banner.endDate) document.getElementById('inpEnd').value = formatDate(banner.endDate);

        document.getElementById('statusToggle').checked = banner.isActive;

        // Handle Image Preview
        const imgPreview = document.getElementById('imgPreview');
        const placeholder = document.getElementById('uploadPlaceholder');
        
        if (banner.image) {
            imgPreview.src = banner.image;
            imgPreview.style.display = 'block';
            placeholder.style.display = 'none';
        }

        // Update UI Text
        document.getElementById('modalTitle').innerText = 'Edit Banner';
        document.getElementById('btnSubmit').innerText = 'Update Banner';

        // Show Modal
        document.getElementById('bannerModal').style.display = 'flex';
    }

    // --- 3. CLOSE MODAL ---
    function closeModal() {
        document.getElementById('bannerModal').style.display = 'none';
    }

    // --- 4. IMAGE PREVIEW ---
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('uploadPlaceholder').style.display = 'none';
                const img = document.getElementById('imgPreview');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    // --- 5. UNIFIED SUBMIT HANDLER ---
    async function handleFormSubmit(event) {
        event.preventDefault();

        const form = document.getElementById('bannerForm');
        const formData = new FormData(form);
        const bannerId = document.getElementById('bannerId').value;
        const btn = document.querySelector('.btn-save')

        Loading.showButton(btn)
        
        // Handle Checkbox manually
        formData.set('isActive', document.getElementById('statusToggle').checked);

        try {
            let response;

            if (bannerId) {
                // === EDIT MODE (PUT) ===
                response = await axios.put(`/admin/banners/edit/${bannerId}`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                
            } else {
                // === ADD MODE (POST) ===
                response = await axios.post('/admin/banners/add', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
            }

            if (response.data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: bannerId ? 'Banner updated successfully' : 'Banner created successfully',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => window.location.reload());
            } else {
                Loading.hideButton(btn)
                Swal.fire('Error', response.data.message, 'error');
            }

        } catch (error) {
             Loading.hideButton(btn)
            console.error(error);
            Swal.fire('Error', error.response?.data?.message || 'Operation failed', 'error');
        }
    }

    // Close on outside click
    window.onclick = function(event) {
        if (event.target == document.getElementById('bannerModal')) {
            closeModal();
        }
    }
</script>