<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/admin/orderList.css">

    <body>
        <div class="admin-layout">

            <%- include('../partials/sidebar',{activePage: 'orders' }) %>
                <main class="main-content">

                    <header class="page-header">
                        <div class="header-text">
                            <h1>Users Orders</h1>
                            <p>View and manage all customer orders.</p>
                        </div>
                        <button class="export-btn">
                            Export Report
                        </button>
                    </header>

                    <section class="search-filter-container card">
                        <form action="/admin/orders" method="GET" class="search-form" id="filterForm"
                            style="display: flex; width: 100%; justify-content: space-between;">

                            <div class="search-bar">
                                <img src="/images/admin/icons/search.png" alt="" class="search-icon">
                                <input type="text" name="search"
                                    placeholder="Search by Order ID, Customer Name, or Email"
                                    value="<%= typeof currentSearch !== 'undefined' ? currentSearch : '' %>">
                                <button type="submit" style="display: none;"></button>
                            </div>

                            <div class="filter-status">

                                <div class="dropdown">
                                    <i class="fa-solid fa-filter" style="color: #6B7280; margin-right: 5px;"></i>
                                    <select name="status" onchange="document.getElementById('filterForm').submit()"
                                        style="border:none; outline:none; background:transparent; font-weight:500; color:#374151; cursor:pointer;">
                                        <option value="All" <%=(!locals.currentStatus || currentStatus==='All' )
                                            ? 'selected' : '' %>>Status: All</option>
                                        <option value="Pending" <%=(locals.currentStatus==='Pending' ) ? 'selected' : ''
                                            %>>Status: Pending</option>
                                        <option value="Processing" <%=(locals.currentStatus==='Processing' )
                                            ? 'selected' : '' %>>Status: Processing</option>
                                        <option value="Shipped" <%=(locals.currentStatus==='Shipped' ) ? 'selected' : ''
                                            %>>Status: Shipped</option>
                                        <option value="Delivered" <%=(locals.currentStatus==='Delivered' ) ? 'selected'
                                            : '' %>>Status: Delivered</option>
                                        <option value="Cancelled" <%=(locals.currentStatus==='Cancelled' ) ? 'selected'
                                            : '' %>>Status: Cancelled</option>
                                        <option value="Returned" <%=(locals.currentStatus==='Returned' ) ? 'selected'
                                            : '' %>>Status: Returned</option>
                                        <option value="Return Request" <%=(locals.currentStatus==='Return Request' )
                                            ? 'selected' : '' %>>Status: Return Request</option>
                                        <option value="Return Rejected" <%=(locals.currentStatus==='Return Rejected' )
                                            ? 'selected' : '' %>>Status: Return Rejected</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down" style="font-size: 10px; margin-left: 5px;"></i>
                                </div>

                                <div class="dropdown">
                                    <span style="font-size:12px;">From:</span>
                                    <input type="date" name="startDate" value="<%= locals.startDate || '' %>"
                                        onchange="document.getElementById('filterForm').submit()"
                                        style="padding-left: 8px;">
                                </div>

                                <div class="dropdown">
                                    <span style="font-size:12px;">To:</span>
                                    <input type="date" name="endDate" value="<%= locals.endDate || '' %>"
                                        onchange="document.getElementById('filterForm').submit()"
                                        style="padding-left: 8px;">
                                </div>

                            </div>
                        </form>
                    </section>

                    <section class="table-container">
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-col"><input type="checkbox"></th>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (orders && orders.length> 0) { %>
                                    <% orders.forEach(order=> { %>
                                        <tr>
                                            <td class="checkbox-col"><input type="checkbox"></td>

                                            <td class="order-id">#<%= order.orderId %>
                                            </td>

                                            <td class="customer-cell">
                                                <div class="customer-info">
                                                    <span class="name">
                                                        <%= order.address.fullName %>
                                                    </span>
                                                </div>
                                            </td>

                                            <td class="date-cell">
                                                <%= new Date(order.createdAt).toLocaleDateString('en-US', {
                                                    month: 'short' , day: 'numeric' , year: 'numeric' }) %>
                                            </td>

                                            <td>
                                                <span
                                                    class="status-badge <%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                                                    <%= order.status %>
                                                </span>
                                            </td>

                                            <td class="amount">
                                                â‚¹<%= Math.round(order.finalAmount).toLocaleString('en-IN') %>
                                            </td>

                                            <td class="actions-cell">
                                                <a href="/admin/orders/details/<%= order._id %>" class="view-btn">
                                                    <i class="fa-regular fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        <% }) %>
                                            <% } else { %>
                                                <tr>
                                                    <td colspan="7" style="text-align:center; padding: 20px;">No orders
                                                        found</td>
                                                </tr>
                                                <% } %>
                            </tbody>
                        </table>

                        <div class="pagination-controls">
                            <% // Create a helper to build the URL with existing filters const
                                getPaginatedUrl=(pageNum)=> {
                                let params = new URLSearchParams();
                                params.append('page', pageNum);
                                if (locals.currentStatus) params.append('status', currentStatus);
                                if (locals.currentSearch) params.append('search', currentSearch);
                                if (locals.startDate) params.append('startDate', startDate);
                                if (locals.endDate) params.append('endDate', endDate);
                                return '/admin/orders?' + params.toString();
                                };
                                %>

                                <% if (currentPage> 1) { %>
                                    <a href="<%= getPaginatedUrl(currentPage - 1) %>" class="btn prev-btn">Previous</a>
                                    <% } else { %>
                                        <button class="btn prev-btn disabled-link" disabled>Previous</button>
                                        <% } %>

                                            <span class="page-info">Page <%= currentPage %> of <%= totalPages %></span>

                                            <% if (currentPage < totalPages) { %>
                                                <a href="<%= getPaginatedUrl(currentPage + 1) %>"
                                                    class="btn btn-primary next-btn">Next</a>
                                                <% } else { %>
                                                    <button class="btn btn-primary next-btn" disabled>Next</button>
                                                    <% } %>
                        </div>
                    </section>

                </main>
        </div>
        <%- include('../partials/footer') %>