<%- include('../partials/header') %>
<link rel="stylesheet" href="/css/admin/category.css">


<body>
    <div class="dashboard-container">
        <%- include('../partials/sidebar', {activePage: 'category'}) %>

        <main class="main-content">
            <header class="main-header mb-4">
                <div class="header-title">
                    <h2>Edit Category: <%= category.categoryName %></h2>
                </div>
                <a href="/admin/category" class="btn-close-custom" style="font-size: 1.5rem; text-decoration: none; color: #666;">&times;</a>
            </header>

            <form id="editCategoryForm">
                
                <section class="card mb-4 p-4">
                    <h5 class="mb-3">Category Details</h5>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-control bg-light" name="categoryName" id="categoryName" value="<%= category.categoryName %>">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="isListed" id="isListed">
                                <option value="true" <%= category.isListed ? 'selected' : '' %>>Listed (Active)</option>
                                <option value="false" <%= !category.isListed ? 'selected' : '' %>>Unlisted</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control bg-light" name="description" id="description" rows="3"><%= category.description %></textarea>
                    </div>
                </section>
                <section class="card mb-4 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Products in this Category</h5>
                        <a href="/admin/add-product" class="btn btn-primary btn-sm">
                            <i class="bi bi-plus"></i>  Add Product
                        </a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (products && products.length > 0) { %>
                                    <% products.forEach(product => { %>
                                        <tr>
                                            <td><%= product.name %></td>
                                           
                                            <td>â‚¹<%= product.price %></td>
                                            <td><%= product.stock %></td>
                                            <td>
                                                <% if (product.isPublished) { %>
                                                    <span class="status-badge status-active badge" style="background-color: rgb(205, 255, 205);">Active</span>
                                                <% } else { %>
                                                    <span class="status-badge status-blocked badge " style="background-color: rgb(255, 227, 227);">Blocked</span>
                                                <% } %>
                                            </td>
                                            <td>
                                             <div class="action-buttons">
                                                    <a href="/admin/edit-product/<%= product._id %>"
                                                        class="action-btn text-primary">
                                                        <i class="bi bi-pencil-square"></i>
                                                    </a>    
                                                    <% if(product.isPublished===true) { %>
                                                        <a href="#" class="action-btn text-danger block-btn"
                                                            title="Click to Unlist" data-product-id="<%= product._id %>"
                                                            data-product-name="<%= product.name %>">
                                                            <i class="bi bi-slash-circle"></i>
                                                        </a>
                                                        <% } else { %>
                                                            <a class="action-btn text-success unblock-btn"
                                                                data-product-id="<%= product._id %>"
                                                                data-product-name="<%= product.name %>"
                                                                title="Click to List">
                                                                <i class="bi bi-check-circle"></i>
                                                            </a>
                                                            <% } %>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }) %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="text-center text-muted p-4">No products are currently assigned to this category.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </section>

                <div class="form-footer d-flex justify-content-end gap-2 mt-4">
                    <a href="/admin/category" class="btn btn-light border">Cancel</a>
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>
            </form>
        </main>
    </div>

    <div id="confirmationModal" class="modal-overlay" style="display: none;">
            <div class="modal-content">

                <div class="modal-header">
                    <h3><span class="warning-icon">&#9888;</span> <span id="modalTitle">Update Product</span></h3>
                    <span class="modal-close-btn">&times;</span>
                </div>

                <div class="modal-body">
                    <p>
                        Are you sure you want to <strong id="actionText">update</strong>
                        <strong id="modalProductName">this product</strong>?
                    </p>
                    <p class="modal-subtitle" id="modalSubText">
                        This action will change the product's visibility.
                    </p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel">Cancel</button>

                    <button type="button" id="confirmActionBtn" class="btn-confirm-block">
                        Confirm
                    </button>
                </div>

            </div>
        </div>


    <script src="/js/axios.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('editCategoryForm');
                    const modal = document.getElementById('confirmationModal'); // Changed ID
                    const modalProductName = document.getElementById('modalProductName');
                    const modalTitle = document.getElementById('modalTitle');
                    const actionText = document.getElementById('actionText');
                    const modalSubText = document.getElementById('modalSubText');
                    const confirmBtn = document.getElementById('confirmActionBtn');
                    const closeBtn = document.querySelector('.modal-close-btn');
                    const cancelBtn = document.querySelector('.btn-cancel');
            
            // Get the Category ID from the EJS variable embedded in script
            const categoryId = '<%= category._id %>'; 
            let targetProductId = null;

            const showToast = (msg, type) => {
                Toastify({
                    text: msg,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    style: { background: type === "success" ? "#28a745" : "#dc3545", borderRadius: '10px' }
                }).showToast();
            };

                 const toggleProductStatus = async (productId) => {
                        try {
                            // Using axios.post with empty body {}
                            const response = await axios.patch(`/admin/products/toggle-block/${productId}`, {});

                            if (response.data.success) {
                                showToast(response.data.message, "success");
                                setTimeout(() => window.location.reload(), 1000);
                            } else {
                                showToast(response.data.message || 'Action failed', 'error');
                            }
                        } catch (err) {
                            console.error(err);
                            showToast(err.response?.data?.message || 'Something went wrong', "error");
                        }
                    };

                    // 2. Open Modal Logic (Handles BOTH Block and Unblock)
                    const openModal = (productId, name, actionType) => {
                        targetProductId = productId;
                        modalProductName.textContent = name;
                        modal.style.display = 'flex';

                        if (actionType === 'block') {
                            // Set UI for Blocking (Red/Warning)
                            modalTitle.textContent = "Block product";
                            actionText.textContent = "block";
                            actionText.style.color = "#dc3545"; // Red
                            modalSubText.textContent = "This product will effectively be hidden from users.";

                            confirmBtn.textContent = "Block product";
                            confirmBtn.className = "btn-confirm-block"; // Red style
                            confirmBtn.style.backgroundColor = "#dc3545"; // Force Red
                        } else {
                            // Set UI for Unblocking (Green/Safe)
                            modalTitle.textContent = "Unblock product";
                            actionText.textContent = "unblock";
                            actionText.style.color = "#28a745"; // Green
                            modalSubText.textContent = "This product will become visible to users again.";

                            confirmBtn.textContent = "Unblock product";
                            confirmBtn.className = "btn-confirm-unblock"; // Green style
                            confirmBtn.style.backgroundColor = "#28a745"; // Force Green
                        }
                    };

                    // 3. Attach Event Listeners to Buttons

                    // Block Buttons
                    document.querySelectorAll('.block-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            const id = this.getAttribute('data-product-id');
                            const name = this.getAttribute('data-product-name');
                            openModal(id, name, 'block');
                        });
                    });

                    // Unblock Buttons (Now opens modal too!)
                    document.querySelectorAll('.unblock-btn').forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            const id = this.getAttribute('data-product-id');


                            const name = this.getAttribute('data-product-name') || 'this brand';
                            openModal(id, name, 'unblock');
                        });
                    });

                    // 4. Confirm Button Click
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', function () {
                            if (targetProductId) {
                                toggleProductStatus(targetProductId);
                                modal.style.display = 'none';
                            }
                        });
                    }

                    // Close Modal Logic
                    const hideModal = () => { modal.style.display = 'none'; };
                    if (closeBtn) closeBtn.addEventListener('click', hideModal);
                    if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
                    window.addEventListener('click', (e) => {
                        if (e.target === modal) hideModal();
                    });
                

            form.addEventListener('submit', async (e) => {
                e.preventDefault(); // Stop page reload

                // Gather data
                const categoryName = document.getElementById('categoryName').value;
                const description = document.getElementById('description').value;
                const isListed = document.getElementById('isListed').value;

                try {
                    // Send PUT request
                    const response = await axios.patch(`/admin/category/edit/${categoryId}`, {
                        categoryName,
                        description,
                        isListed
                    });

                    if (response.data.success) {
                        showToast(response.data.message, 'success');
                        
                        setTimeout(() => {
                            window.location.href = '/admin/category';
                        }, 1000);
                    } else {
                        showToast(response.data.message, 'error');
                    }
                } catch (error) {
                    console.error(error);
                    const errMsg = error.response?.data?.message || 'Something went wrong';
                    showToast(errMsg, 'error');
                }
            });
        });
    </script>
    </body>
</html>
