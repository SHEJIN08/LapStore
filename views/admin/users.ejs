<%- include('../partials/header') %>

<link rel="stylesheet" href="/css/admin/userManagement.css">

<body>

    <div class="dashboard-container">

        <%- include('../partials/sidebar',{activePage: 'users' }) %>

        <main class="main-content">

            <header class="main-header">
                <div class="header-title">
                    <h2>User Management</h2>
                    <p>List all users and manage access.</p>
                </div>
                </header>

            <div class="search-filter-container card">
                <form action="/admin/users" method="GET" class="search-form">
                    <div class="search-bar">
                        <img src="/images/admin/icons/search.png" alt="" class="search-icon">
                        <input type="text" name="search" placeholder="Search by name, email, or user ID..."
                            value="<%= typeof currentSearch !== 'undefined' ? currentSearch : '' %>">
                    </div>

                    <div class="filter-status">
                        <img src="/images/admin/icons/filter.png" alt="" class="filter-icon">
                        <select name="status">
                            <option value="all" <%=(typeof currentStatus==='undefined' || currentStatus==='all' )
                                ? 'selected' : '' %>>
                                Status: All
                            </option>
                            <option value="active" <%=(typeof currentStatus !=='undefined' && currentStatus==='active' )
                                ? 'selected' : '' %>>
                                Status: Active
                            </option>
                            <option value="blocked" <%=(typeof currentStatus !=='undefined' && currentStatus==='blocked'
                                ) ? 'selected' : '' %>>
                                Status: Blocked
                            </option>
                            <option value="pending" <%=(typeof currentStatus !=='undefined' && currentStatus==='pending'
                                ) ? 'selected' : '' %>>
                                Status: Pending
                            </option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary">Filter</button>
                </form>
            </div>

            <section class="orders-table card">

                <table>
                    <thead>
                        <tr>
                            <th scope="col"><img src="/images/admin/icons/box.png" alt=""
                                    style="width: 20px; height: 20px;"></th>
                            <th scope="col">User</th>
                            <th scope="col">Status</th>
                            <th scope="col">UserId</th>
                            <th scope="col">RegisterationDate</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>

                    <tbody>
                        <% users.forEach(user=> { %>
                        <tr>
                            <td><input type="checkbox" style="width: 20px; height: 20px;"></td>
                            <td>
                                <%= user.name %> <br>
                                <%= user.email %>
                            </td>
                            <td>
                                <% if (!user.isVerified) { %>
                                <span class="status-badge status-pending">Pending</span>
                                <% } else if (user.isActive) { %>
                                <span class="status-badge status-active">Active</span>
                                <% } else { %>
                                <span class="status-badge status-blocked">Blocked</span>
                                <% } %>
                            </td>
                            <td>
                                <%= user.userId %>
                            </td>
                            <td>
                                <%= String(user.createdAt).split(' ').slice(1,4).join(" ") %>
                            </td>
                            <td>

                                <div class="dropdown">
                                    <button class="btn btn-light border-0 p-0" data-bs-toggle="dropdown">
                                        <img src="/images/admin/userManagement.png" alt="" width="20px" height="20px">
                                    </button>

                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <% if (!user.isActive) { %>
                                        <li>
                                            <form action="/admin/users/toggle-block/<%= user._id %>" method="POST"
                                                class="dropdown-form">
                                                <button type="submit" class="dropdown-item text-success">
                                                    <i class="bi bi-shield-check me-2"></i> Unblock
                                                </button>
                                            </form>
                                        </li>
                                        <% } else { %>
                                        <li>
                                            <a class="dropdown-item text-warning block-user-trigger" href="#"
                                                data-user-id="<%= user._id %>" data-user-name="<%= user.name %>">
                                                <i class="bi bi-shield-x me-2"></i> Block
                                            </a>
                                        </li>
                                        <% } %>
                                    </ul>
                                </div>

                            </td>
                        </tr>
                        <% }) %>

                    </tbody>
                </table>

                <div class="pagination-container">
                    <span class="pagination-info">
                        <% if (totalUsers> 0) { %>
                        Showing <%= (currentPage - 1) * limit + 1 %>-<%= Math.min(currentPage * limit, totalUsers) %> of
                        <%= totalUsers %>
                        <% } else { %>
                        No users found.
                        <% } %>
                    </span>

                    <div class="pagination-controls">
                        <a href="/admin/users?page=<%= currentPage - 1 %>&search=<%= currentSearch %>&status=<%= currentStatus %>"
                            class="btn  prev-btn <%= currentPage <= 1 ? 'disabled-link' : '' %>">
                            Previous
                        </a>

                        <a href="/admin/users?page=<%= currentPage + 1 %>&search=<%= currentSearch %>&status=<%= currentStatus %>"
                            class="btn btn-primary next-btn <%= currentPage >= totalPages ? 'disabled-link' : '' %>">
                            Next
                        </a>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div id="blockModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">

            <div class="modal-header">
                <h3><span class="warning-icon">&#9888;</span> Block User</h3>
                <span class="modal-close-btn">&times;</span>
            </div>

            <div class="modal-body">
                <p>
                    Are you sure you want to block
                    <strong id="modalUserName">John Smith</strong>?
                </p>
                <p class="modal-subtitle">
                    This user will no longer be able to access their account.
                    You can unblock them later.
                </p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-cancel">Cancel</button>

                <form id="blockUserForm" action="" method="POST" style="display: inline;">
                    <button type="submit" class="btn-confirm-block">Block User</button>
                </form>
            </div>

        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- Block Modal Logic Only ---
            const blockModal = document.getElementById('blockModal');
            if (blockModal) {
                const closeBtn = blockModal.querySelector('.modal-close-btn');
                const cancelBtn = blockModal.querySelector('.btn-cancel');
                const userNameSpan = blockModal.querySelector('#modalUserName');
                const blockForm = blockModal.querySelector('#blockUserForm');
                const allBlockButtons = document.querySelectorAll('.block-user-trigger');

                const showBlockModal = (id, name) => {
                    userNameSpan.textContent = name;
                    blockForm.action = `/admin/users/toggle-block/${id}`;
                    blockModal.style.display = 'flex';
                };

                const hideBlockModal = () => {
                    blockModal.style.display = 'none';
                };

                allBlockButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const userId = button.dataset.userId;
                        const userName = button.dataset.userName;
                        showBlockModal(userId, userName);
                    });
                });

                closeBtn.addEventListener('click', hideBlockModal);
                cancelBtn.addEventListener('click', hideBlockModal);
                blockModal.addEventListener('click', (event) => {
                    if (event.target === blockModal) {
                        hideBlockModal();
                    }
                });
            }
        }); 
    </script>

    <input type="text" id="message" value="<%= message %>" name="message" hidden>
    <input type="hidden" id="type" value="<%= type %>" name="value">
    <%- include('../partials/footer') %>