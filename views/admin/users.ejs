<%- include('../partials/header') %>

    <link rel="stylesheet" href="/css/admin/userManagement.css">

    <body>

        <div class="dashboard-container">

            <%- include('../partials/sidebar',{activePage: 'users' }) %>

                <main class="main-content">

                    <header class="main-header">
                        <div class="header-title">
                            <h2>User Management</h2>
                            <p>List all users.</p>
                        </div>
                        <div class="header-controls">
                            <button class="btn btn-primary">Export Report</button>
                        </div>
                    </header>

                    <section class="orders-table card">

                        <table>
                            <thead>
                                <tr>
                                    <th scope="col"><img src="/images/admin/icons/box.png" alt=""
                                            style="width: 20px; height: 20px;"></th>
                                    <th scope="col">User</th>
                                    <th scope="col">Status</th>
                                    <th scope="col">UserId</th>
                                    <th scope="col">RegisterationDate</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>

                            <tbody>
                                <% users.forEach(user=> { %>
                                    <tr>
                                        <td><input type="checkbox" style="width: 20px; height: 20px;"></td>
                                        <td>
                                            <%= user.name %> <br>
                                                <%= user.email %>
                                        </td>
                                        <td>
                                            <span
                                                class="status-badge <%= user.isActive ? 'status-active' : 'status-blocked' %>">
                                                <%= user.isActive ? "Active" : "Blocked" %>
                                            </span>
                                        </td>
                                        <td>
                                            <%= user.userId %>
                                        </td>
                                        <td>
                                            <%= String(user.createdAt).split(' ').slice(1,4).join(" ") %></td>
                                    <td>
                                                    
                            <div class="dropdown">
                                <button class="btn btn-light border-0 p-0" data-bs-toggle="dropdown">
                                    <img src="/images/admin/userManagement.png" alt="" width="20px" height="20px">
                                </button>
                                
                                <ul class="dropdown-menu dropdown-menu-end">
                                    
                                    <% if (!user.isActive) { %>
                                        <li>
                                            <form action="/admin/users/toggle-block/<%= user._id %>" method="POST" class="dropdown-form">
                                                <button type="submit" class="dropdown-item text-success">
                                                    <i class="bi bi-shield-check me-2"></i> Unblock
                                                </button>
                                            </form>
                                        </li>
                                    <% } else { %>
                                        <li>
                                            <a class="dropdown-item text-warning block-user-trigger" 
                                            href="#" 
                                            data-user-id="<%= user._id %>" 
                                            data-user-name="<%= user.name %>">
                                                <i class="bi bi-shield-x me-2"></i> Block
                                            </a>
                                        </li>
                                    <% } %>

                                   <li>
                                    <a class="dropdown-item edit-user-trigger" 
                                      href="#" 
                                         data-user=' <%- JSON.stringify(user) %>'>
                                                <i class="bi bi-pencil-square me-2"></i> Edit
                                                </a>
                                                </li>

                                                <li>
                                                    <a class="dropdown-item text-danger delete-user-trigger" href="#"
                                                        data-user-id="<%= user._id %>"
                                                        data-user-name="<%= user.name %>">
                                                        <i class="bi bi-trash me-2"></i> Delete
                                                    </a>
                                                </li>
                                                </ul>
        </div>

        </td>
        </tr>
        <% }) %>

            </tbody>
            </table>

            <a href="#" class="view-all-link">View All Orders</a>
            </section>

            </main>
            </div>

            // --- Block modal ---
            <div id="blockModal" class="modal-overlay" style="display: none;">
                <div class="modal-content">

                    <div class="modal-header">
                        <h3><span class="warning-icon">&#9888;</span> Block User</h3>
                        <span class="modal-close-btn">&times;</span>
                    </div>

                    <div class="modal-body">
                        <p>
                            Are you sure you want to block
                            <strong id="modalUserName">John Smith</strong>?
                        </p>
                        <p class="modal-subtitle">
                            This user will no longer be able to access their account.
                            You can unblock them later.
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel">Cancel</button>

                        <form id="blockUserForm" action="" method="POST" style="display: inline;">
                            <button type="submit" class="btn-confirm-block">Block User</button>
                        </form>
                    </div>

                </div>
            </div>

            // --- Delete modal ---

            <div id="deleteModal" class="modal-overlay" style="display: none;">
                <div class="modal-content">

                    <div class="modal-header">
                        <h3><span class="danger-icon">&#9888;</span> Delete User</h3>
                        <span class="modal-close-btn">&times;</span>
                    </div>

                    <div class="modal-body">
                        <p>
                            Are you sure you want to delete
                            <strong id="modalDeleteUserName">Jane Doe</strong>?
                        </p>
                        <p class="modal-subtitle">
                            This action cannot be undone.
                        </p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel">Cancel</button>

                        <form id="deleteUserForm" action="" method="POST" style="display: inline;">
                            <button type="submit" class="btn-confirm-delete">Delete User</button>
                        </form>
                    </div>

                </div>
            </div>


            // --- Edit modal ---
            <div id="editModal" class="modal-overlay" style="display: none;">
                <div class="modal-content" style="max-width: 650px;">
                    <div class="modal-header">
                        <h3>Edit User</h3>
                        <span class="modal-close-btn">&times;</span>
                    </div>

                    <form id="editUserForm" action="" method="POST">
                        <div class="modal-body">

                            <div class.form-grid>

                                <div class="form-group">
                                    <label for="editUserName">Name</label>
                                    <input type="text" id="editUserName" name="name">
                                </div>

                                <div class="form-group">
                                    <label for="editUserEmail">Email</label>
                                    <input type="email" id="editUserEmail" name="email">
                                </div>

                                <div class="form-group">
                                    <label for="editUserPhone">Phone Number</label>
                                    <input type="text" id="editUserPhone" name="phone">
                                </div>

                                <div class="form-group">
                                    <label for="editUserId">User ID</label>
                                    <input type="text" id="editUserId" name="userId" disabled>
                                    <small>User ID cannot be changed.</small>
                                </div>

                                <div class="form-group form-group-full">
                                    <label for="editUserAddress">Address</label>
                                    <input type="text" id="editUserAddress" name="address">
                                </div>

                                <div class="form-group">
                                    <label for="editUserStatus">Status</label>
                                    <select id="editUserStatus" name="isActive">
                                        <option value="true">Active</option>
                                        <option value="false">Blocked</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="editRegDate">Registration Date</label>
                                    <input type="text" id="editRegDate" name="regDate" disabled>
                                </div>

                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn-cancel">Cancel</button>
                            <button type="submit" class="btn-confirm-save">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', () => {

                    // --- Block Modal Logic ---
                    const blockModal = document.getElementById('blockModal');
                    if (blockModal) {
                        const closeBtn = blockModal.querySelector('.modal-close-btn');
                        const cancelBtn = blockModal.querySelector('.btn-cancel');
                        const userNameSpan = blockModal.querySelector('#modalUserName');
                        const blockForm = blockModal.querySelector('#blockUserForm');
                        const allBlockButtons = document.querySelectorAll('.block-user-trigger');

                        const showBlockModal = (id, name) => {
                            userNameSpan.textContent = name;
                            blockForm.action = `/admin/users/toggle-block/${id}`;
                            blockModal.style.display = 'flex';
                        };

                        const hideBlockModal = () => {
                            blockModal.style.display = 'none';
                        };

                        allBlockButtons.forEach(button => {
                            button.addEventListener('click', (e) => {
                                e.preventDefault();
                                const userId = button.dataset.userId;
                                const userName = button.dataset.userName;
                                showBlockModal(userId, userName);
                            });
                        });

                        closeBtn.addEventListener('click', hideBlockModal);
                        cancelBtn.addEventListener('click', hideBlockModal);
                        blockModal.addEventListener('click', (event) => {
                            if (event.target === blockModal) {
                                hideBlockModal();
                            }
                        });
                    } // --- End of Block Modal Logic ---


                    // --- Delete Modal Logic  ---
                    const deleteModal = document.getElementById('deleteModal');
                    if (deleteModal) {

                        const closeBtn = deleteModal.querySelector('.modal-close-btn');
                        const cancelBtn = deleteModal.querySelector('.btn-cancel');
                        const userNameSpan = deleteModal.querySelector('#modalDeleteUserName');
                        const deleteForm = deleteModal.querySelector('#deleteUserForm');
                        const allDeleteButtons = document.querySelectorAll('.delete-user-trigger');

                        const showDeleteModal = (id, name) => {
                            userNameSpan.textContent = name;
                            deleteForm.action = `/admin/users/delete/${id}`;
                            deleteModal.style.display = 'flex';
                        };

                        const hideDeleteModal = () => {
                            deleteModal.style.display = 'none';
                        };

                        allDeleteButtons.forEach(button => {
                            button.addEventListener('click', (e) => {
                                e.preventDefault();
                                const userId = button.dataset.userId;
                                const userName = button.dataset.userName;
                                showDeleteModal(userId, userName);
                            });
                        });

                        closeBtn.addEventListener('click', hideDeleteModal);
                        cancelBtn.addEventListener('click', hideDeleteModal);
                        deleteModal.addEventListener('click', (event) => {
                            if (event.target === deleteModal) {
                                hideDeleteModal();
                            }
                        });
                    } // --- End of Delete Modal Logic ---

                    
                    // --- Edit Modal Logic  ---
                    const editModal = document.getElementById('editModal');
                    if (editModal) {

                        // Get modal elements
                        const closeBtn = editModal.querySelector('.modal-close-btn');
                        const cancelBtn = editModal.querySelector('.btn-cancel');
                        const editForm = editModal.querySelector('#editUserForm');
                        const allEditTriggers = document.querySelectorAll('.edit-user-trigger');

                        // Get all form inputs
                        const nameInput = editModal.querySelector('#editUserName');
                        const emailInput = editModal.querySelector('#editUserEmail');
                        const phoneInput = editModal.querySelector('#editUserPhone');
                        const addressInput = editModal.querySelector('#editUserAddress');
                        const userIdInput = editModal.querySelector('#editUserId');
                        const statusInput = editModal.querySelector('#editUserStatus');
                        const regDateInput = editModal.querySelector('#editRegDate');

                        const showEditModal = (user) => {
                            // 1. Populate the form
                            nameInput.value = user.name;
                            emailInput.value = user.email;
                            userIdInput.value = user.userId;

                            // Use || '' for fields you might add, so it doesn't show "undefined"
                            phoneInput.value = user.phone || '';
                            addressInput.value = user.address || '';

                            // Set the <select> dropdown
                            statusInput.value = user.isActive; // This works if value="true" or "false"

                            // Format the registration date
                            const date = new Date(user.createdAt);
                            regDateInput.value = date.toISOString().split('T')[0];

                            // 2. Set the form's action
                            editForm.action = `/admin/users/edit/${user._id}`;

                            // 3. Show the modal
                            editModal.style.display = 'flex';
                        };

                        const hideEditModal = () => {
                            editModal.style.display = 'none';
                        };

                        // Add click listener to all "Edit" triggers
                        allEditTriggers.forEach(button => {
                            button.addEventListener('click', (e) => {
                                e.preventDefault();

                                // Get the user data from the data-user attribute
                                const userString = button.dataset.user;
                                const user = JSON.parse(userString);

                                showEditModal(user);
                            });
                        });

                        closeBtn.addEventListener('click', hideEditModal);
                        cancelBtn.addEventListener('click', hideEditModal);
                        editModal.addEventListener('click', (event) => {
                            if (event.target === editModal) {
                                hideEditModal();
                            }
                        });
                    }
                    // --- End of Edit Modal Logic ---

                }); // --- End of DOMContentLoaded ---
            </script>

            <input type="text" id="message" value="<%= message %>" name="message" hidden>
            <input type="hidden" id="type" value="<%= type %>" name="value">
            <%- include('../partials/footer') %>