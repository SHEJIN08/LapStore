<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/user/ordersPage.css">

    <body>
        <%- include('../partials/navbar') %>

            <div class="main-container">

                <%- include('./partials/profileSidebar', {active: 'ordersPage' }) %>

                    <main class="content">

                        <div class="page-header">
                            <h1>My Orders</h1>
                            <p>View and manage your past and current orders.</p>
                        </div>

                        <div class="order-tabs">
                            <a href="/user/home/orders"
                                class="tab-link <%= currentStatus === 'All' ? 'active' : '' %>">All Orders</a>

                            <a href="/user/home/orders?status=Pending"
                                class="tab-link <%= currentStatus === 'Pending' ? 'active' : '' %>">Pending</a>

                            <a href="/user/home/orders?status=Shipped"
                                class="tab-link <%= currentStatus === 'Shipped' ? 'active' : '' %>">Shipped</a>

                            <a href="/user/home/orders?status=Delivered"
                                class="tab-link <%= currentStatus === 'Delivered' ? 'active' : '' %>">Delivered</a>

                            <a href="/user/home/orders?status=Cancelled"
                                class="tab-link <%= currentStatus === 'Cancelled' ? 'active' : '' %>">Cancelled</a>
                        </div>

                        <div class="orders-list">
                            <% if (orders && orders.length> 0) { %>
                                <% orders.forEach(order=> { %>
                                    <div class="order-card">
                                        <div class="card-top">
                                            <span class="order-id">Order ID: #<%= order.orderId %></span>
                                            <span
                                                class="status-badge <%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                                                <span class="dot"></span>
                                                <%= order.status %>
                                            </span>
                                        </div>

                                        <div class="card-body">
                                            <table class="order-table-layout">
                                                <tbody>
                                                    <tr>
                                                        <td class="col-info">
                                                            <h3>
                                                                <%= order.orderedItems[0].productName %>
                                                            </h3>
                                                            <% if(order.orderedItems.length> 1) { %>
                                                                <span class="more-items">+ <%= order.orderedItems.length
                                                                        - 1 %> other item(s)</span>
                                                                <% } %>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Qty</span>
                                                            <span class="val">
                                                                <%= order.orderedItems[0].quantity %>
                                                            </span>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Date</span>
                                                            <span class="val">
                                                                <%= new Date(order.createdAt).toLocaleDateString() %>
                                                            </span>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Total</span>
                                                            <span class="val total-price">$<%=
                                                                    order.finalAmount.toLocaleString() %></span>
                                                        </td>

                                                        <td class="col-actions">
                                                            <a href="/user/home/orders/details/<%= order._id %>"
                                                                class="btn-secondary">View</a>

                                                            <% if(order.status==='Pending' ||
                                                                order.status==='Processing' ) { %>
                                                                <button class="btn-cancel  unq-cnl"
                                                                    onclick="cancelOrder('<%= order._id %>')"> Cancel
                                                                </button>
                                                                <% } %>

                                                        </td>
                                                    </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <p>No orders found.</p>
                                            <% } %>
                        </div>

                        <div class="pagination-container">
                            <a href="#" class="nav-link prev disabled">Previous</a>
                            <div class="page-numbers">
                                <a href="#" class="page-num active">1</a>
                                <a href="#" class="page-num">2</a>
                                <a href="#" class="page-num">3</a>
                            </div>
                            <a href="#" class="nav-link next">Next â†’</a>
                        </div>

                    </main>
            </div>

            <%- include('../partials/footer') %>
    </body>

    <script src="/js/axios.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>

       const showToast = (msg, type) => {
                Toastify({
                    text: msg,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    className: "my-custom-toast",
                    backgroundColor: type === "success" ? "#28a745" : "linear-gradient(to right, #e52d27, #b31217)",borderRadius: '10px'
                }).showToast();
            };
        
        async function cancelOrder(orderId) {
            // 1. Confirm with the user
            const result = await Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to cancel this order?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, cancel it!'
            });

            if (!result.isConfirmed) return;

            try {
                // 2. Send Request to Backend
                const response = await axios.patch('/user/home/orders/cancel', { orderId });

                if (response.data.success) {
                    // 3. Success! Show message and reload
                    await Swal.fire(
                        'Cancelled!',
                        'Your order has been cancelled.',
                        'success'
                    );
                    window.location.reload();
                } else {
                    showToast(response.data.message, 'error');
                }

            } catch (error) {
                console.error(error);
                 const errMsg = error.response?.data?.message || "Something went wrong";
                    showToast(errMsg, "error");
            }
        }
    </script>