<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/user/ordersPage.css">

    <body>
        <%- include('../partials/navbar') %>

            <div class="main-container">

                <%- include('./partials/profileSidebar', {active: 'ordersPage' }) %>

                    <main class="content">

                        <div class="page-header">
                            <h1>My Orders</h1>
                            <p>View and manage your past and current orders.</p>
                        </div>

                        <div class="order-tabs">
                            <a href="/user/home/orders"
                                class="tab-link <%= currentStatus === 'All' ? 'active' : '' %>">All Orders</a>

                            <a href="/user/home/orders?status=Pending"
                                class="tab-link <%= currentStatus === 'Pending' ? 'active' : '' %>">Pending</a>

                            <a href="/user/home/orders?status=Processing"
                                class="tab-link <%= currentStatus === 'Processing' ? 'active' : '' %>">Processing</a>


                            <a href="/user/home/orders?status=Shipped"
                                class="tab-link <%= currentStatus === 'Shipped' ? 'active' : '' %>">Shipped</a>

                            <a href="/user/home/orders?status=Out for Delivery"
                                class="tab-link <%= currentStatus === 'Out of Delivery' ? 'active' : '' %>">Out of
                                Delivery</a>

                            <a href="/user/home/orders?status=Delivered"
                                class="tab-link <%= currentStatus === 'Delivered' ? 'active' : '' %>">Delivered</a>

                            <a href="/user/home/orders?status=Cancelled"
                                class="tab-link <%= currentStatus === 'Cancelled' ? 'active' : '' %>">Cancelled</a>
                        </div>

                        <div class="orders-toolbar">

                            <div class="toolbar-left">
                     
                            </div>

                            <div class="search-container">
                                <form action="/user/home/orders" method="GET" class="search-form">

                                    <% if (currentStatus && currentStatus !=='All' ) { %>
                                        <input type="hidden" name="status" value="<%= currentStatus %>">
                                        <% } %>

                                            <div class="input-group">
                                                <span class="search-icon">
                                                    <i class="fa-solid fa-magnifying-glass"></i>
                                                </span>
                                                <input type="text" name="search"
                                                    placeholder="Search by Order ID or Product..."
                                                    value="<%= currentSearch %>" autocomplete="off">
                                                <% if (currentSearch) { %>
                                                    <a href="/user/home/orders?status=<%= currentStatus %>"
                                                        class="clear-search">
                                                        <i class="fa-solid fa-xmark"></i>
                                                    </a>
                                                    <% } %>
                                            </div>
                                            <button type="submit" class="btn-search">Search</button>
                                </form>
                            </div>
                        </div>

                        <div class="orders-list">
                            <% if (orders && orders.length> 0) { %>
                                <% orders.forEach(order=> { %>
                                    <div class="order-card">
                                        <div class="card-top">
                                            <span class="order-id">Order ID: #<%= order.orderId %></span>
                                            <span
                                                class="status-badge <%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                                                <span class="dot"></span>
                                                <%= order.status %>
                                            </span>
                                        </div>

                                        <div class="card-body">
                                            <table class="order-table-layout">
                                                <tbody>
                                                    <tr>
                                                        <td class="col-info">
                                                            <h3>
                                                                <%= order.orderedItems[0].productName %>
                                                            </h3>
                                                            <% if(order.orderedItems.length> 1) { %>
                                                                <span class="more-items">+ <%= order.orderedItems.length
                                                                        - 1 %> other item(s)</span>
                                                                <% } %>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Qty</span>
                                                            <span class="val">
                                                                <%= order.orderedItems[0].quantity %>
                                                            </span>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Date</span>
                                                            <span class="val">
                                                                <%= new Date(order.createdAt).toLocaleDateString() %>
                                                            </span>
                                                        </td>

                                                        <td class="col-meta">
                                                            <span class="label">Total</span>
                                                            <span class="val total-price">₹<%=
                                                                    order.finalAmount.toLocaleString() %></span>
                                                        </td>

                                                        <td class="col-actions">
                                                            <a href="/user/home/orders/details/<%= order._id %>"
                                                                class="btn-secondary">View</a>

                                                            <% if (order.status==='Pending' ||
                                                                order.status==='Processing' ) { %>
                                                                <button class="btn-cancel  cnl-unq"
                                                                    onclick="openCancelModal('<%= order._id %>')">
                                                                    Cancel Order
                                                                </button>
                                                                <% } %>
                                                        </td>
                                                    </tr>

                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <% }) %>
                                        <% } else { %>
                                            <p>No orders found.</p>
                                            <% } %>
                        </div>

                        <div class="pagination-container">
                            <% if (totalPages> 1) { %>

                                <% if (currentPage> 1) { %>
                                    <a href="?page=<%= currentPage - 1 %>&status=<%= currentStatus %>"
                                        class="nav-link prev">Previous</a>
                                    <% } else { %>
                                        <span class="nav-link prev disabled">Previous</span>
                                        <% } %>

                                            <div class="page-numbers">
                                                <% for(let i=1; i <=totalPages; i++) { %>
                                                    <a href="?page=<%= i %>&status=<%= currentStatus %>"
                                                        class="page-num <%= currentPage === i ? 'active' : '' %>">
                                                        <%= i %>
                                                    </a>
                                                    <% } %>
                                            </div>

                                            <% if (currentPage < totalPages) { %>
                                                <a href="?page=<%= currentPage + 1 %>&status=<%= currentStatus %>"
                                                    class="nav-link next">Next →</a>
                                                <% } else { %>
                                                    <span class="nav-link next disabled">Next →</span>
                                                    <% } %>

                                                        <% } %>
                        </div>

                    </main>
            </div>

            <div id="cancelModal" class="modal-overlay hidden">
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 class="modal-title">Confirm Order Cancellation</h2>
                        <button class="close-btn" onclick="closeModal()">&times;</button>
                    </div>

                    <p class="modal-subtitle">
                        Are you sure you want to cancel this order? This action cannot be undone.
                    </p>

                    <div class="reasons-form">
                        <label class="reason-group">
                            Reason for cancellation
                        </label>

                        <div class="reasons-grid">
                            <label class="reason-card">
                                <input type="radio" name="cancelReason" value="Changed mind"
                                    onclick="toggleOther(false)">
                                <span class="reason-text">Changed mind</span>
                            </label>

                            <label class="reason-card">
                                <input type="radio" name="cancelReason" value="Found a better deal"
                                    onclick="toggleOther(false)">
                                <span class="reason-text">Found a better deal</span>
                            </label>

                            <label class="reason-card">
                                <input type="radio" name="cancelReason" value="Long delivery time"
                                    onclick="toggleOther(false)">
                                <span class="reason-text">Long delivery time</span>
                            </label>

                            <label class="reason-card">
                                <input type="radio" name="cancelReason" value="Ordered by mistake"
                                    onclick="toggleOther(false)">
                                <span class="reason-text">Ordered by mistake</span>
                            </label>

                            <label class="reason-card full-width">
                                <input type="radio" name="cancelReason" value="Other" onclick="toggleOther(true)">
                                <span class="reason-text">Other reason (optional)</span>
                            </label>
                        </div>

                        <div id="otherReasonContainer" class="other-input-container hidden">
                            <textarea id="otherReasonText" placeholder="Please specify your reason..."
                                rows="3"></textarea>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn-keep" onclick="closeModal()">Keep Order</button>
                        <button class="btn-confirm-cancel" onclick="submitCancellation()">Confirm Cancel</button>
                    </div>
                </div>
            </div>

            <%- include('../partials/footer') %>

                <script src="/js/axios.min.js"></script>

                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

                <script>

                    const showToast = (message, type) => {
                        const bgColor = type === 'success' ? "linear-gradient(to right, #30E527, #238500)" : "linear-gradient(to right, #e52d27, #b31217)";
                        Toastify({
                            text: message,
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            style: { background: bgColor, borderRadius: '10px' }
                        }).showToast();
                    };


                    let currentOrderId = null;


                    function openCancelModal(orderId) {
                        currentOrderId = orderId;
                        document.getElementById('cancelModal').classList.remove('hidden');


                        const radios = document.getElementsByName('cancelReason');
                        radios.forEach(r => r.checked = false);
                        document.getElementById('otherReasonContainer').classList.add('hidden');
                        document.getElementById('otherReasonText').value = '';
                    }


                    function closeModal() {
                        currentOrderId = null;
                        document.getElementById('cancelModal').classList.add('hidden');
                    }


                    function toggleOther(show) {
                        const container = document.getElementById('otherReasonContainer');
                        if (show) {
                            container.classList.remove('hidden');
                        } else {
                            container.classList.add('hidden');
                        }
                    }


                    async function submitCancellation() {
                        if (!currentOrderId) return;


                        const radios = document.getElementsByName('cancelReason');
                        let selectedReason = null;
                        for (const radio of radios) {
                            if (radio.checked) {
                                selectedReason = radio.value;
                                break;
                            }
                        }

                        if (!selectedReason) {
                            showToast('Please select a reason for cancellation', 'error');
                            return;
                        }


                        if (selectedReason === 'Other') {
                            const otherText = document.getElementById('otherReasonText').value.trim();
                            if (!otherText) {
                                showToast('Please specify your reason', 'error');
                                return;
                            }
                            selectedReason = otherText;
                        }


                        try {
                            const response = await axios.patch('/user/orders/cancel', {
                                orderId: currentOrderId,
                                reason: selectedReason
                            });

                            if (response.data.success) {
                                closeModal();
                                await Swal.fire({
                                    icon: 'success',
                                    title: 'Order Cancelled',
                                    text: 'Your order has been cancelled successfully.',
                                    confirmButtonColor: '#10B981'
                                });
                                window.location.reload();
                            } else {
                                showToast(response.data.message || 'Failed to cancel', 'error');
                            }
                        } catch (error) {
                            console.error(error);
                            showToast('Something went wrong', 'error');
                        }
                    }

                </script>