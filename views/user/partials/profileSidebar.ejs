<link rel="stylesheet" href="/css/user/profileSidebar.css">

<aside class="sidebar card">
    <div class="user-summary">
        
        <div class="image-container">
    <img src="<%= (user.avatar && user.avatar !== 'user') ? user.avatar : '/images/user/defaultUser.jpg' %>" 
         alt="Profile pic" 
         class="profile-img"
         id="profileImageDisplay">

    <label for="profileUpload" class="upload-icon">
        <i class="fa-solid fa-camera"></i>
    </label>
    <input type="file" 
           id="profileUpload" 
           name="avatar" 
           accept="image/*" 
           style="display: none;">
</div>

        <div class="user-details">
            <h3><%= user.name %></h3>
            <span><%= user.email %></span>
        </div>
    </div>

    <nav class="sidebar-menu">
        <a href="/user/home/profile" class="menu-item <%= (active === 'personalPage')? 'active' : ''   %>">
            <i class="fa-regular fa-user"></i> Personal Information
        </a>
        <a href="/user/home/manageAddress" class="menu-item <%= (active === 'addressPage')? 'active' : ''   %>">
            <i class="fa-solid fa-location-dot"></i> Manage Address
        </a>
        <a href="/user/home/orders" class="menu-item <%= (active === 'ordersPage')? 'active' : ''  %>">
            <i class="fa-regular fa-file-lines"></i> My Orders
        </a>
        <a href="/user/home/wallet" class="menu-item <%= (active === 'walletPage')? 'active' : ''  %>">
            <i class="fa-solid fa-wallet"></i> My Wallet
        </a>
        <a href="#" class="menu-item <%= (active === 'referPage')? 'active' : ''  %>">
            <i class="fa-solid fa-gift"></i> Refer & Earn
        </a>
        <a href="/user/logout" class="menu-item logout <%= (active === 'logoutPage')? 'active' : ''  %>">
            <i class="fa-solid fa-right-from-bracket"></i> Logout
        </a>
    </nav>
</aside>

<div id="cropperModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 500px; max-width: 90%;">
        <div class="modal-header">
            <h3>Crop Image</h3>
            <span class="close-modal" onclick="closeCropperModal()">&times;</span>
        </div>
        
        <div class="modal-body" style="height: 400px; display: flex; justify-content: center; align-items: center; background: #f0f0f0; overflow: hidden;">
            <img id="imageToCrop" src="" style="max-width: 100%; max-height: 100%; display: block;">
        </div>

        <div class="modal-footer" style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button class="btn-cancel" onclick="closeCropperModal()" style="padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
            <button class="btn-save" id="cropAndSave" style="width: auto;">Save & Upload</button>
        </div>
    </div>
</div>
<script>
    let cropper;
    const inputImage = document.getElementById('profileUpload');
    const modal = document.getElementById('cropperModal');
    const imageToCrop = document.getElementById('imageToCrop');
    const saveButton = document.getElementById('cropAndSave');

    // 1. Listen for file selection
    inputImage.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files && files.length > 0) {
            const file = files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                imageToCrop.src = event.target.result;
                modal.style.display = 'flex'; // Show modal

                // Destroy old cropper if exists to avoid bugs
                if (cropper) {
                    cropper.destroy();
                }

                // Initialize Cropper
                cropper = new Cropper(imageToCrop, {
                    aspectRatio: 1, // 1:1 Square for avatars
                    viewMode: 1,    // Restrict crop box to image size
                    autoCropArea: 1,
                });
            };
            reader.readAsDataURL(file);
        }
    });

    // 2. Handle "Save & Upload"
    saveButton.addEventListener('click', () => {
        if (cropper) {
            // Get the cropped canvas
            const canvas = cropper.getCroppedCanvas({
                width: 300,  // Resize to reasonable size for avatar
                height: 300,
            });
            saveButton.textContent = 'saving...'
            // Convert canvas to Blob (file-like object)
            canvas.toBlob((blob) => {
                const formData = new FormData();
                // 'avatar' must match the name your Multer config expects
                formData.append('avatar', blob, 'profile-pic.png'); 

                // Send to Server
                fetch('/user/home/profile/upload-profile-pic', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload(); // Reload to see new image
                    } else {
                        alert('Upload failed. Please try again.');
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Something went wrong.');
                });
            }, 'image/png');
        }
    });

    // 3. Helper to close modal
    function closeCropperModal() {
        modal.style.display = 'none';
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        inputImage.value = ''; // Reset input so same file can be selected again
    }
</script>