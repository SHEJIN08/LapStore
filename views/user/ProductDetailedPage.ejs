<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/user/productDetailedPage.css">

    <body>
        <%- include('../partials/navbar') %>
            <main class="container" style="margin-top: 20px;">

                <nav class="breadcrumbs">
                    <a href="/">Home</a> &gt;
                    <a href="/user/home/shop">Shop</a> &gt;
                    <a href="/user/home/shop?page=1&category=<%= product.category.slug %>">
                        <%= product.category.categoryName %>
                    </a> &gt;
                    <span>
                        <%= product.name %>
                    </span>
                </nav>

                <section class="product-detail">
                    <div class="product-images">
                        <div class="main-image" id="img-container" style="position: relative;"> <% if (product.hasOffer) { %>
                                <div class="offer-badge">
                                    <% if (product.offerType === 'percentage') { %>
                                        <%= product.offerValue %>% OFF
                                    <% } else if (product.offerType === 'fixed') { %>
                                        SAVE ₹<%= product.offerValue %>
                                    <% } else { %>
                                        OFFER
                                    <% } %>
                                </div>
                            <% } %>
                            <img id="mainImg" src="<%= product.images[0] %>" alt="<%= product.name %>"
                                style="width:100%; height:100%; object-fit:contain;">

                            <div id="zoom-lens" class="img-zoom-lens"></div>
                        </div>

                        <div id="zoom-result" class="img-zoom-result"></div>

                        <div class="thumbnail-list" id="thumbnail-list" style="margin-top: 20px;">
                            <% product.images.forEach((img, index)=> { %>
                                <div class="thumbnail <%= index === 0 ? 'active' : '' %>"
                                    onclick="changeImage(this, '<%= img %>')">
                                    <img src="<%= img %>" alt="Thumbnail">
                                </div>
                                <% }) %>
                        </div>
                    </div>
                    
                    <div class="product-info">
                        <span class="brand">
                            <%= product.brand?.brandName || 'Brand' %>
                        </span>

                        <h1 class="product-title">
                            <%= product.name %>
                        </h1>

                        <div class="rating">
                            <div class="stars">
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-regular fa-star-half-stroke"></i>
                            </div>
                            <span class="review-count">4.8 (412 reviews)</span>
                        </div>

                        <div class="price">
                            <% if (product.hasOffer) { %>
                                <span class="original-price" id="displayOriginal" style="color: red;">
                                    ₹<%= product.originalPrice.toLocaleString('en-IN') %>
                                </span>
                                <span class="sale-price price-highlight" id="displaySale">
                                    ₹<%= product.finalPrice.toLocaleString('en-IN') %>
                                </span> 
                            <% } else { %>
                                <span class="sale-price" id="displaySale">
                                    ₹<%= product.originalPrice.toLocaleString('en-IN') %>
                                </span>
                                <span class="original-price" id="displayOriginal" style="display:none"></span>
                            <% } %>
                        </div>

                        <p class="description">
                            <%= product.description || 'Experience the power and portability of this premium laptop.' %>
                        </p>

                        <% if(product.variants && product.variants.length> 0) { %>
                            <div class="product-option">
                                <h3 class="option-title">Configuration</h3>
                                <div class="config-options">

                                    <% product.variants.forEach((variant, index)=> { %>
                                        
                                        <% 
                                            
                                            let variantOriginal = variant.salePrice; // This is the database price
                                            let variantFinal = variantOriginal;

                                            if(product.hasOffer) {
                                                if(product.offerType === 'percentage') {
                                                    let discount = (variantOriginal * product.offerValue) / 100;
                                                    variantFinal = Math.round(variantOriginal - discount);
                                                } else if (product.offerType === 'fixed') {
                                                    variantFinal = Math.max(0, variantOriginal - product.offerValue);
                                                }
                                            }
                                        %>

                                        <label class="config-box <%= index === 0 ? 'selected' : '' %>"
                                            data-image="<%= variant.image %>"
                                            onclick="selectVariant(this, '<%= variantFinal %>', '<%= variantOriginal %>')">

                                            <input type="radio" name="variant" value="<%= variant._id %>" <%=index===0
                                                ? 'checked' : '' %>>

                                            <span class="config-details">
                                                <%= variant.ram %> / <%= variant.storage %> / <i>
                                                                <%= variant.graphics %>
                                                            </i>
                                            </span>
                                            
                                            <span class="config-price">
                                                ₹<%= variantFinal.toLocaleString('en-IN') %>
                                            </span>
                                        </label>
                                    <% }) %>

                                </div>
                            </div>
                            <% } %>

                                <div class="specs-section">
                                    <h3 class="section-title">Specification</h3>
                                    <ul>
                                        <% if (product.specifications && product.specifications.length> 0) { %>
                                            <% product.specifications.forEach(spec=> { %>
                                                <li>
                                                    <span style="font-weight: 600; color: #333;">
                                                        <%= spec.key %>
                                                    </span>
                                                    <span style="color: #666;">
                                                        <%= spec.value %>
                                                    </span>
                                                </li>
                                                <% }) %>
                                                    <% } else { %>
                                                        <li> <span>No specifications available for this product </span>
                                                        </li>
                                                        <% } %>
                                    </ul>
                                </div>
                                <div class="product-actions">
                                    <button class="btn-add-to-cart" onclick="addToCart()">
                                        <i class="fa-solid fa-cart-plus"></i> Add to Cart
                                    </button>
                                     <button class="wishlist-btn" style="margin-top: 7px;"
                                        onclick="addToWishlist(event, '<%= product._id %>')">
                                        <i class="fa-regular fa-heart"></i>
                                     </button>
                                </div>

                                <div class="additional-info">
                                    <div class="info-item">
                                        <i class="fa-solid fa-truck"></i> Free shipping on orders over ₹1,00,000
                                    </div>
                                    <div class="info-item">
                                        <i class="fa-solid fa-shield-halved"></i> Official Warranty
                                    </div>
                                </div>
                    </div>
                </section>

                <section class="customer-reviews">
                    <div class="section-header">
                        <h2 class="section-heading">Customer Reviews</h2>
                        <button class="btn-add-review">Add a Review</button>
                    </div>
                    <div class="review-list">
                        <p style="color: #666;">No reviews yet. Be the first to review!</p>
                    </div>
                </section>

                <% if(relatedProducts && relatedProducts.length> 0) { %>
                    <section class="related-products">
                        <h2 class="section-heading">Related Products</h2>
                        <div>
                            <div class="product-grid">

                                <% relatedProducts.forEach(rel=> { %>
                                    <div class="product-card">
                                        <div class="card-image" style="position: relative;">
                                            
                                            <% if (rel.hasOffer) { %>
                                                <div class="offer-badge-small">
                                                    <% if (rel.offerType === 'percentage') { %>
                                                        <%= rel.offerValue %>% OFF
                                                    <% } else { %>
                                                        ₹<%= rel.offerValue %> OFF
                                                    <% } %>
                                                </div>
                                            <% } %>

                                            <a href="/user/product/<%= rel.slug %>">
                                                <img src="<%= rel.images[0] %>" alt="<%= rel.name %>">
                                            </a>
                                             <button class="wishlist-btn-cat" style="margin-top: 7px;"
                                            onclick="addToWishlist(event, '<%= product._id %>')">
                                            <i class="fa-regular fa-heart"></i>
                                     </button>
                                        </div>
                                        <div class="card-info">
                                            <span class="card-brand">
                                                <%= rel.brand?.brandName || 'Generic' %>
                                            </span>
                                            <h3 class="card-title"><a href="/user/product/<%= rel.slug %>">
                                                    <%= rel.name %>
                                                </a></h3>

                                            <div class="card-price">
                                                <% if (rel.hasOffer) { %>
                                                    <span class="card-sale" style="color: #e53637; font-weight: bold;">
                                                        ₹<%= rel.finalPrice.toLocaleString('en-IN') %>
                                                    </span>
                                                    <del style="color: #999; font-size: 13px; margin-left: 5px;">
                                                        ₹<%= rel.originalPrice.toLocaleString('en-IN') %>
                                                    </del>
                                                <% } else { %>
                                                    <span class="card-sale">₹<%= rel.originalPrice.toLocaleString('en-IN') %></span>
                                                <% } %>
                                            </div>
                                        </div>
                                    </div>
                                    <% }) %>

                            </div>
                        </div>
                    </section>
                    <% } %>

            </main>

            <%- include('../partials/footer') %>

                <script src="/js/axios.min.js"></script>


                <script>
                 
                    const container = document.getElementById("img-container");
                    const mainImg = document.getElementById("mainImg");
                    const lens = document.getElementById("zoom-lens");
                    const result = document.getElementById("zoom-result");

                  
                    const cx = result.offsetWidth / lens.offsetWidth;
                    const cy = result.offsetHeight / lens.offsetHeight;

                  
                    container.addEventListener("mouseenter", () => {
                        lens.style.visibility = "visible";
                        result.style.visibility = "visible";

                     
                        result.style.backgroundImage = `url('${mainImg.src}')`;
                        result.style.backgroundSize = (mainImg.width * cx) + "px " + (mainImg.height * cy) + "px";
                    });

                    container.addEventListener("mouseleave", () => {
                        lens.style.visibility = "hidden";
                        result.style.visibility = "hidden";
                    });

                    container.addEventListener("mousemove", moveLens);
                    container.addEventListener("touchmove", moveLens); 

                  
                    function moveLens(e) {
                        e.preventDefault();

                        // 1. Get cursor position
                        const pos = getCursorPos(e);
                        let x = pos.x - (lens.offsetWidth / 2);
                        let y = pos.y - (lens.offsetHeight / 2);

                        // 2. Boundary Checks (Don't let lens go outside image)
                        if (x > mainImg.width - lens.offsetWidth) { x = mainImg.width - lens.offsetWidth; }
                        if (x < 0) { x = 0; }
                        if (y > mainImg.height - lens.offsetHeight) { y = mainImg.height - lens.offsetHeight; }
                        if (y < 0) { y = 0; }

                        // 3. Move the lens
                        lens.style.left = x + "px";
                        lens.style.top = y + "px";

                        // 4. Move the result background
                        // We move the background in the OPPOSITE direction (-) times the ratio
                        result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
                    }

                    function getCursorPos(e) {
                        let a, x = 0, y = 0;
                        e = e || window.event;
                        a = mainImg.getBoundingClientRect();
                        x = e.pageX - a.left;
                        y = e.pageY - a.top;
                        x = x - window.pageXOffset;
                        y = y - window.pageYOffset;
                        return { x: x, y: y };
                    }

                  
                    function changeImage(element, src) {
                        // 1. Update Main Image
                        mainImg.src = src;

                        // 2. Update Zoom Background immediately
                        result.style.backgroundImage = `url('${src}')`;

                        // 3. Update Thumbnail Styling
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        element.classList.add('active');
                    }

                    // --- VARIANT SELECTOR ---
                    function selectVariant(element, salePrice, regularPrice) {
                        // 1. UI Updates (Styling & Radio Buttons)
                        document.querySelectorAll('.config-box').forEach(box => box.classList.remove('selected'));
                        element.classList.add('selected');
                        element.querySelector('input[type="radio"]').checked = true;

                        // 2. Price Updates
                        document.getElementById('displaySale').innerText = `₹${Number(salePrice).toLocaleString('en-IN')}`;
                        document.getElementById('displayOriginal').innerText = `₹${Number(regularPrice).toLocaleString('en-IN')}`;

                        // 3. Image Updates
                        const variantImage = element.getAttribute('data-image');
                        if (variantImage) {
                            // Update Main Image
                            mainImg.src = variantImage;

                            // Update Zoom Background
                            result.style.backgroundImage = `url('${variantImage}')`;

                            // Update Thumbnails if match found
                            const firstThumbnail = document.querySelector('.thumbnail-list .thumbnail');
                            if (firstThumbnail) {
                                firstThumbnail.querySelector('img').src = variantImage;
                                firstThumbnail.setAttribute('onclick', `changeImage(this, '${variantImage}')`);

                                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                                firstThumbnail.classList.add('active');
                            }
                        }
                    }

                    const showToast = (message, type) => {
                        const bgColor = type === 'success' ? "linear-gradient(to right, #30E527, #238500)" : "linear-gradient(to right, #e52d27, #b31217)";
                        Toastify({
                            text: message,
                            duration: 3000,
                            gravity: "top",
                            position: "right",
                            style: { background: bgColor, borderRadius: '10px' }
                        }).showToast();
                    };


                    // --- ADD TO CART FUNCTION ---
                    async function addToCart() {
                        try {
                         
                            const productId = '<%= product._id %>';

                            const selectedVariant = document.querySelector('input[name="variant"]:checked');

                            if (!selectedVariant) {
                                showToast("Please select a configuration option", "error");
                                return;
                            }

                            const variantId = selectedVariant.value;

                          
                            const response = await axios.post('/user/home/cart/add', {
                                productId: productId,
                                variantId: variantId,
                                quantity: 1
                            });

                          
                            if (response.data.success) {
                                showToast("Item added to cart successfully!", "success");

                            

                            } else {
                                showToast(response.data.message, "error");
                            }

                        } catch (error) {
                            console.error(error);
                            if (error.response && error.response.status === 401) {
                                showToast("Please login to add items to cart", "error");
                                setTimeout(() => {
                                    window.location.href = '/user/login'
                                }, 2000)

                            } else {
                             
                                showToast("Failed to add to cart", "error");
                            }
                        }
                    }

    async function addToWishlist(event, productId) {
    // 1. Stop navigation
    event.preventDefault();
    event.stopPropagation();

    

    const btn = event.currentTarget;
    const icon = btn.querySelector('i');

    // 2. FIND SELECTED VARIANT (Dynamic Check)
    // This ensures we get the variant the user actually clicked on
    const selectedVariant = document.querySelector('input[name="variant"]:checked');
    
    if (!selectedVariant) {
        showToast("Please select a configuration option", "error");
        return;
    }
    
    const variantId = selectedVariant.value;

    try {
        // 3. Send API Request
        const response = await axios.post('/user/wishlist/add', {
            productId: productId,
            variantId: variantId
        });

        if (response.data.success) {
            showToast('Item added to the wishlist', 'success');

            // 4. Update UI (Visual Feedback)
            icon.classList.remove('fa-regular');
            icon.classList.add('fa-solid');
            icon.style.color = '#ef4444'; // Red color

            // Bounce animation
            btn.style.transform = "scale(1.2)";
            setTimeout(() => btn.style.transform = "scale(1)", 200);
        }

    } catch (error) {
        console.error(error);
       
        let message = "Something went wrong";
        
        if(error.response){
       if (error.response.data && error.response.data.message) {
                message = error.response.data.message;
            }

            // Handle Not Logged In (401)
            if (error.response.status === 401) {
               message = "Please login to add items to wishlist";
                setTimeout(() => {
                    window.location.href = '/user/login';
                }, 1500);
                return;
            }
        }
        showToast(message, "error");
        }
        
    }   
                </script>
    </body>