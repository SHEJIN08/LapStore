<%- include('../partials/header') %>
    <link rel="stylesheet" href="/css/user/productDetailedPage.css">


    <body>
        <%- include('../partials/navbar') %>
            <main class="container" style="margin-top: 20px;">

                <nav class="breadcrumbs">
                    <a href="/">Home</a> &gt;
                    <a href="/user/category/<%= product.category.slug %>"><%= product.category.categoryName %></a> &gt;
                    <span>
                        <%= product.name %>
                    </span>
                </nav>

                <section class="product-detail">
                    <div class="product-images">
                        <div class="main-image" id="img-container">
                            <img id="mainImg" src="<%= product.images[0] %>" alt="<%= product.name %>"
                                style="width:100%; height:100%; object-fit:contain;">

                            <div id="zoom-lens" class="img-zoom-lens"></div>
                        </div>

                        <div id="zoom-result" class="img-zoom-result"></div>

                        <div class="thumbnail-list" id="thumbnail-list" style="margin-top: 20px;">
                            <% product.images.forEach((img, index)=> { %>
                                <div class="thumbnail <%= index === 0 ? 'active' : '' %>"
                                    onclick="changeImage(this, '<%= img %>')">
                                    <img src="<%= img %>" alt="Thumbnail">
                                </div>
                                <% }) %>
                        </div>
                    </div>
                    <div class="product-info">
                        <span class="brand">
                            <%= product.brand?.brandName || 'Brand' %>
                        </span>

                        <h1 class="product-title">
                            <%= product.name %>
                        </h1>

                        <div class="rating">
                            <div class="stars">
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-solid fa-star"></i>
                                <i class="fa-regular fa-star-half-stroke"></i>
                            </div>
                            <span class="review-count">4.8 (412 reviews)</span>
                        </div>

                        <div class="price">
                            <% if(product.variants && product.variants.length> 0) { %>
                                <% const firstVar=product.variants[0]; %>
                                    <span class="original-price" id="displayOriginal">₹<%=
                                            firstVar.regularPrice.toLocaleString('en-IN') %></span>
                                    <span class="sale-price" id="displaySale">₹<%=
                                            firstVar.salePrice.toLocaleString('en-IN') %></span>
                                    <% } else { %>
                                        <span class="sale-price">Currently Unavailable</span>
                                        <% } %>
                        </div>

                        <p class="description">
                            <%= product.description || 'Experience the power and portability of this premium laptop.' %>
                        </p>

                        <% if(product.variants && product.variants.length> 0) { %>
                            <div class="product-option">
                                <h3 class="option-title">Configuration</h3>
                                <div class="config-options">

                                    <% product.variants.forEach((variant, index)=> { %>
                                        <label class="config-box <%= index === 0 ? 'selected' : '' %>"
                                            data-image="<%= variant.image %>"
                                            onclick="selectVariant(this, '<%= variant.salePrice %>', '<%= variant.regularPrice  %>')">

                                            <input type="radio" name="variant" value="<%= variant._id %>" <%=index===0
                                                ? 'checked' : '' %>>

                                            <span class="config-details">
                                                <%= variant.ram %> / <%= variant.storage %> / <i>
                                                            <%= variant.graphics %>
                                                        </i>
                                            </span>
                                            <span class="config-price">₹<%= variant.regularPrice.toLocaleString('en-IN')
                                                    %>
                                            </span>
                                        </label>
                                        <% }) %>

                                </div>
                            </div>
                            <% } %>

                                <div class="specs-section">
                                    <h3 class="section-title">Specification</h3>
                                    <ul>
                                        <% if (product.specifications && product.specifications.length> 0) { %>
                                            <% product.specifications.forEach(spec=> { %>
                                                <li>
                                                    <span style="font-weight: 600; color: #333;">
                                                        <%= spec.key %>
                                                    </span>
                                                    <span style="color: #666;">
                                                        <%= spec.value %>
                                                    </span>
                                                </li>
                                                <% }) %>
                                                    <% } else { %>
                                                        <li> <span>No specifications available for this product </span>
                                                        </li>
                                                        <% } %>
                                    </ul>
                                </div>
                                <div class="product-actions">
                                    <button class="btn-add-to-cart" onclick="addToCart()">
                                        <i class="fa-solid fa-cart-plus"></i> Add to Cart
                                    </button>
                                    <button class="btn-wishlist">
                                        <i class="fa-regular fa-heart"></i>
                                    </button>
                                </div>

                                <div class="additional-info">
                                    <div class="info-item">
                                        <i class="fa-solid fa-truck"></i> Free shipping on orders over ₹10,000
                                    </div>
                                    <div class="info-item">
                                        <i class="fa-solid fa-shield-halved"></i> Official Warranty
                                    </div>
                                </div>
                    </div>
                </section>

                <section class="customer-reviews">
                    <div class="section-header">
                        <h2 class="section-heading">Customer Reviews</h2>
                        <button class="btn-add-review">Add a Review</button>
                    </div>
                    <div class="review-list">
                        <p style="color: #666;">No reviews yet. Be the first to review!</p>
                    </div>
                </section>

                <% if(relatedProducts && relatedProducts.length> 0) { %>
                    <section class="related-products">
                        <h2 class="section-heading">Related Products</h2>
                        <div>
                            <div class="product-grid">

                                <% relatedProducts.forEach(rel=> { %>
                                    <div class="product-card">
                                        <div class="card-image">
                                            <a href="/user/product/<%= rel.slug %>">
                                                <img src="<%= rel.images[0] %>" alt="<%= rel.name %>">
                                            </a>
                                            <button class="card-wishlist-btn"><i
                                                    class="fa-regular fa-heart"></i></button>
                                        </div>
                                        <div class="card-info">
                                            <span class="card-brand">
                                                <%= rel.brand?.brandName || 'Generic' %>
                                            </span>
                                            <h3 class="card-title"><a href="/user/product/<%= rel.slug %>">
                                                    <%= rel.name %>
                                                </a></h3>

                                            <div class="card-price">

                                                <span class="card-sale">From ₹<%= rel.minPrice.toLocaleString('en-IN')
                                                        %></span>
                                            </div>
                                        </div>
                                    </div>
                                    <% }) %>

                            </div>
                        </div>
                    </section>
                    <% } %>

            </main>

            <%- include('../partials/footer') %>

                <script src="/js/axios.min.js"></script>


              <script>
    // --- ELEMENTS ---
    const container = document.getElementById("img-container");
    const mainImg = document.getElementById("mainImg");
    const lens = document.getElementById("zoom-lens");
    const result = document.getElementById("zoom-result");

    // --- ZOOM CONFIGURATION ---
    // Calculate ratio: Result Window Width / Lens Width
    const cx = result.offsetWidth / lens.offsetWidth; 
    const cy = result.offsetHeight / lens.offsetHeight;

    // --- EVENT LISTENERS ---
    container.addEventListener("mouseenter", () => {
        lens.style.visibility = "visible";
        result.style.visibility = "visible";
        
        // Load the image into the background of the result div
        result.style.backgroundImage = `url('${mainImg.src}')`;
        result.style.backgroundSize = (mainImg.width * cx) + "px " + (mainImg.height * cy) + "px";
    });

    container.addEventListener("mouseleave", () => {
        lens.style.visibility = "hidden";
        result.style.visibility = "hidden";
    });

    container.addEventListener("mousemove", moveLens);
    container.addEventListener("touchmove", moveLens); // For touch screens

    // --- ZOOM LOGIC (THE MATH) ---
    function moveLens(e) {
        e.preventDefault();

        // 1. Get cursor position
        const pos = getCursorPos(e);
        let x = pos.x - (lens.offsetWidth / 2);
        let y = pos.y - (lens.offsetHeight / 2);

        // 2. Boundary Checks (Don't let lens go outside image)
        if (x > mainImg.width - lens.offsetWidth) { x = mainImg.width - lens.offsetWidth; }
        if (x < 0) { x = 0; }
        if (y > mainImg.height - lens.offsetHeight) { y = mainImg.height - lens.offsetHeight; }
        if (y < 0) { y = 0; }

        // 3. Move the lens
        lens.style.left = x + "px";
        lens.style.top = y + "px";

        // 4. Move the result background
        // We move the background in the OPPOSITE direction (-) times the ratio
        result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
    }

    function getCursorPos(e) {
        let a, x = 0, y = 0;
        e = e || window.event;
        a = mainImg.getBoundingClientRect();
        x = e.pageX - a.left;
        y = e.pageY - a.top;
        x = x - window.pageXOffset;
        y = y - window.pageYOffset;
        return {x : x, y : y};
    }

    // --- IMAGE SWITCHER (THUMBNAILS) ---
    function changeImage(element, src) {
        // 1. Update Main Image
        mainImg.src = src;
        
        // 2. Update Zoom Background immediately
        result.style.backgroundImage = `url('${src}')`;
        
        // 3. Update Thumbnail Styling
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        element.classList.add('active');
    }

    // --- VARIANT SELECTOR ---
    function selectVariant(element, salePrice, regularPrice) {
        // 1. UI Updates (Styling & Radio Buttons)
        document.querySelectorAll('.config-box').forEach(box => box.classList.remove('selected'));
        element.classList.add('selected');
        element.querySelector('input[type="radio"]').checked = true;

        // 2. Price Updates
        document.getElementById('displaySale').innerText = `₹${Number(salePrice).toLocaleString('en-IN')}`;
        document.getElementById('displayOriginal').innerText = `₹${Number(regularPrice).toLocaleString('en-IN')}`;

        // 3. Image Updates
        const variantImage = element.getAttribute('data-image');
        if (variantImage) {
            // Update Main Image
            mainImg.src = variantImage;
            
            // Update Zoom Background
            result.style.backgroundImage = `url('${variantImage}')`; 

            // Update Thumbnails if match found
            const firstThumbnail = document.querySelector('.thumbnail-list .thumbnail');
            if (firstThumbnail) {
                firstThumbnail.querySelector('img').src = variantImage;
                firstThumbnail.setAttribute('onclick', `changeImage(this, '${variantImage}')`);
                
                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                firstThumbnail.classList.add('active');
            }
        }
    }
</script>
    </body>