<link rel="stylesheet" href="/css/user/otp.css">
<%- include('../partials/header') %>

 
<div class="top-bar">
        3-7 business days delivery | Free returns
    </div>

    <header class="main-header">
        <a href="#" class="logo">
            <div class="logo-icon">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/laptop.png" alt="LapStore Logo Icon" width="20">
            </div>
            <span class="logo-name">LapStore</span>
        </a>
        <nav class="navigation">
            <a href="#" class="login-link">Login</a>
            <a href="#" class="btn btn-signup">Sign Up</a>
        </nav>
    </header>
<main class="content-wrapper">
<div class="verification-card">
    <h1>Verify Your Account</h1>
            <p>Enter the 6-digit OTP sent to your email.</p>

    <form id="otpForm">

        <div class="otp-inputs">
            <input type="text" maxlength="1"  class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
        </div>
 


        <input type="hidden" id="fullOtp" name="otp">

       <button type="submit" class="btn btn-primary">Verify & Continue</button>

        

        <p class="resend-text">
                Didn't get the OTP? 
                <a href="/user/resend-otp" id="resendLink">Resend in 30s</a>
            </p>

            <div id="timer"></div>
    </form>
</div>
  
</main>
 <script src="/js/axios.min.js"></script>
<script>
    // 1. Setup Toastify Function
    const showToast = (message, type) => {
        const bgColor = type === 'success' ? "#28a745" : "#dc3545";
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: { background: bgColor, borderRadius: '10px' }
        }).showToast();
    };

    // 2. Timer Logic (Runs immediately on page load)
 const expiresAtString = '<%= otpExpiresAt %>';
    let expiresAt = (expiresAtString && expiresAtString !== 'undefined') ? Number(expiresAtString) : 0;
    
    const timerElement = document.getElementById("timer");
    const resendLink = document.getElementById("resendLink");
    const otpForm = document.getElementById('otpForm');

    function updateTimer() {

        if (expiresAt === 0) {
            timerElement.textContent = ""; // Clear text (or say "Request a new OTP")
            
            // Enable Resend Link immediately
            resendLink.style.pointerEvents = "auto";
            resendLink.style.cursor = "pointer";
            resendLink.style.color = "#3B82F6"; 
            resendLink.innerText = "Resend Now";
            return;
        }
        const now = Date.now();
        const diff = expiresAt - now;

        if (diff <= 0) {
            timerElement.innerHTML = "<span style='color:red'>OTP expired!</span>";
            
            // Enable the link
            
            resendLink.style.pointerEvents = "auto";
            resendLink.style.cursor = "pointer"; 
            resendLink.style.color = "#3B82F6"; 
            resendLink.innerText = "Resend Now";
            return; 
        }

        const totalSeconds = Math.floor(diff / 1000);
        timerElement.textContent = `OTP expires in ${totalSeconds}s`;

        // Disable link while timer is running
        resendLink.style.pointerEvents = "none";
        resendLink.style.cursor = "default";
        resendLink.style.color = "gray";
      

        setTimeout(updateTimer, 1000);
    }
    
    // Start the timer initially
    updateTimer(); 

    // 3. Handle Resend Click
    if (resendLink) {
        resendLink.addEventListener('click', async (e) => {
            e.preventDefault(); // Stop any default navigation

            try {
                // Send background request
                const response = await axios.get('/user/resend-otp'); 

                if (response.data.success) {
                    showToast(response.data.message, "success");

                    // Reset Timer (Add 60 seconds)
                    expiresAt = Date.now() + 60000; 
                    updateTimer(); // Restart the loop
                } else {
                    showToast(response.data.message, "error");
                }
            } catch (error) {
                console.error(error);
                showToast("Failed to resend OTP", "error");
            }
        });
    }

    // 4. Input Focus Logic
    const inputs = document.querySelectorAll(".otp-input");
    const fullOtpInput = document.getElementById("fullOtp");

    inputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, ''); 
            
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            updateHiddenInput();
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && index > 0 && input.value === "") {
                inputs[index - 1].focus();
            }
        });
    });

    function updateHiddenInput() {
        let otp = "";
        inputs.forEach(i => otp += i.value);
        fullOtpInput.value = otp;
    }

    // 5. Form Submission Logic
    otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const otpValue = document.getElementById('fullOtp').value;

        if (otpValue.length !== 6) {
            showToast("Please enter the full 6-digit OTP", "error");
            return;
        }

        try {
            const response = await axios.post('/user/verify-otp', { otp: otpValue });

            if (response.data.success) {
                showToast("Verification Successful!", "success");
                setTimeout(() => {
                    window.location.href = response.data.redirectUrl || '/user/login';
                }, 1500);
            } else {
                showToast(response.data.message || "Verification Failed", "error");
            }

        } catch (error) {
            console.error(error);
            const errMsg = error.response?.data?.message || "Something went wrong";
            showToast(errMsg, "error");
        }
    });
</script>


<%- include('../partials/footer') %>