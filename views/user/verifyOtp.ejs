<link rel="stylesheet" href="/css/user/otp.css">
<%- include('../partials/header') %>

 
<div class="top-bar">
        3-7 business days delivery | Free returns
    </div>

    <header class="main-header">
        <a href="#" class="logo">
            <div class="logo-icon">
                <img src="https://img.icons8.com/ios-filled/50/ffffff/laptop.png" alt="LapStore Logo Icon" width="20">
            </div>
            <span class="logo-name">LapStore</span>
        </a>
        <nav class="navigation">
            <a href="#" class="login-link">Login</a>
            <a href="#" class="btn btn-signup">Sign Up</a>
        </nav>
    </header>
<main class="content-wrapper">
<div class="verification-card">
    <h1>Verify Your Account</h1>
            <p>Enter the 6-digit OTP sent to your email.</p>

    <form id="otpForm">

        <div class="otp-inputs">
            <input type="text" maxlength="1"  class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
            <input type="text" maxlength="1" class="otp-input" required>
        </div>
 


        <input type="hidden" id="fullOtp" name="otp">

       <button type="submit" class="btn btn-primary">Verify & Continue</button>

        

        <p class="resend-text">
                Didn't get the OTP? <a href="/user/resend-otp">Resend in 30s</a>
            </p>

            <div id="timer"></div>
    </form>
</div>
  
</main>
 <script src="/js/axios.min.js"></script>
<script>
    // 1. Setup Toastify Function
    const showToast = (message, type) => {
        const bgColor = type === 'success' ? "#28a745" : "#dc3545";
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: { background: bgColor }
        }).showToast();
    };

    // 2. Timer Logic (Runs immediately on page load)
    const expiresAt = JSON.parse('<%= JSON.stringify(otpExpiresAt) %>');
    const timerElement = document.getElementById("timer");
    const resendLink = document.getElementById("resendLink");
    const otpForm = document.getElementById('otpForm');

 function updateTimer() {
        const now = Date.now();
        const diff = expiresAt - now;

        if (diff <= 0) {
            timerElement.innerHTML = "<span style='color:red'>OTP expired!</span>";
            resendLink.style.pointerEvents = "auto";
            resendLink.style.color = "#3B82F6"; 
            resendLink.innerText = "Resend Now";
            return;
        }

        // âœ… MODIFIED: Calculate total seconds only
        const totalSeconds = Math.floor(diff / 1000);
        
        timerElement.textContent = `OTP expires in ${totalSeconds}s`;

        setTimeout(updateTimer, 1000);
    }
    updateTimer(); // Start timer immediately

    // 3. Input Focus Logic (Runs immediately)
    const inputs = document.querySelectorAll(".otp-input");
    const fullOtpInput = document.getElementById("fullOtp");

    inputs.forEach((input, index) => {
        // Allow only numbers
        input.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, ''); // Remove non-numbers
            
            if (input.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            updateHiddenInput();
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && index > 0 && input.value === "") {
                inputs[index - 1].focus();
            }
        });
    });

    function updateHiddenInput() {
        let otp = "";
        inputs.forEach(i => otp += i.value);
        fullOtpInput.value = otp;
    }

    // 4. Form Submission Logic (Runs ONLY when you click verify)
    otpForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Get the value from the hidden input
        const otpValue = document.getElementById('fullOtp').value;

        // Validation: Ensure 6 digits
        if (otpValue.length !== 6) {
            showToast("Please enter the full 6-digit OTP", "error");
            return;
        }

        try {
            // FIX: You must send the data { otp: ... } to the server!
            const response = await axios.post('/user/verify-otp', { 
                otp: otpValue 
            });

            if (response.data.success) {
                showToast("Verification Successful!", "success");
                setTimeout(() => {
                    // Redirect to home or login based on your flow
                   window.location.href = response.data.redirectUrl || '/user/login';
                }, 1500);
            } else {
                showToast(response.data.message || "Verification Failed", "error");
            }

        } catch (error) {
            console.error(error);
            const errMsg = error.response?.data?.message || "Something went wrong";
            showToast(errMsg, "error");
        }
    });
</script>


<%- include('../partials/footer') %>