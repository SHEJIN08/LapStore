<%- include('../partials/header') %>

<link rel="stylesheet" href="/css/user/checkout.css">

<body>
    <%- include('../partials/navbar') %>

    <div class="main-container">
        
        <h1 class="page-title">Checkout</h1>

        <form id="checkoutForm">
            <div class="checkout-layout">
                
                <div class="checkout-left">
                    
                    <section class="checkout-section">
                        <div class="section-header">
                            <h2 class="section-title">Delivery Address</h2>
                           <button type="button" class="add-new-btn" onclick="openAddressModal()">+ Add New</button>
                        </div>

                        <div class="address-grid">
                            <% if (addresses && addresses.length > 0) { %>
                                <% addresses.forEach((addr, index) => { %>
                                    <label class="selection-card address-card <%= addr.isDefault ? 'selected' : '' %>">
                                        <input type="radio" name="addressId" value="<%= addr._id %>" 
                                               <%= addr.isDefault ? 'checked' : '' %> 
                                               onchange="selectCard(this)">
                                        
                                        <div class="card-content">
                                            <div class="card-header">
                                                <span class="addr-name"><%= addr.fullName %></span>
                                                <span class="addr-type"><%= addr.addressType %></span>
                                            </div>
                                            <p class="addr-text">
                                                <%= addr.address1 %>, <%= addr.city %>, <%= addr.state %> <%= addr.pincode %>
                                            </p>
                                            <p class="addr-phone">Phone: <%= addr.phone %></p>
                                        </div>

                                   
                                    </label>
                                <% }) %>
                            <% } else { %>
                                <p>No addresses found. Please add one.</p>
                            <% } %>
                        </div>
                    </section>

                    <section class="checkout-section">
                        <h2 class="section-title">Payment Method</h2>
                        
                        <div class="payment-options">
                            <label class="selection-card payment-card">
                                <input type="radio" name="paymentMethod" value="COD" onchange="selectCard(this)">
                                <div class="card-content">
                                    <span class="payment-name">Cash on Delivery (COD)</span>
                                </div>
                            </label>

                            <label class="selection-card payment-card">
                                <input type="radio" name="paymentMethod" value="Wallet" onchange="selectCard(this)">
                                <div class="card-content">
                                    <span class="payment-name">Wallet</span>
                                    <span class="wallet-balance">Balance: ₹<%= user.walletBalance || 0 %></span>
                                    <span class="error-text" id="walletError" style="display: none;">Insufficient balance</span>
                                </div>
                            </label>

                            <label class="selection-card payment-card selected">
                                <input type="radio" name="paymentMethod" value="Razorpay" checked onchange="selectCard(this)">
                                <div class="card-content">
                                    <span class="payment-name">Razorpay (Online Payment)</span>
                                </div>
                            </label>
                        </div>
                    </section>

                </div>

               <div class="checkout-right">
                    <div class="summary-card">
                        <h3>Order Summary</h3>
                        
                        <div class="mini-cart-list">
                            <% cartItems.forEach(item => { %>
                                <div class="mini-item">
                                    <div class="mini-img">
                                        <img src="<%= item.variantId.image %>" alt="Product">
                                    </div>
                                    <div class="mini-details">
                                        <h4><%= item.productId.name %></h4>
                                        <p>Qty: <%= item.quantity %></p>
                                        <span class="mini-price">₹<%= item.variantId.salePrice.toLocaleString() %></span>
                                    </div>
                                </div>
                            <% }) %>
                        </div>

                        <div class="divider"></div>

                        <div class="summary-row">
                            <span>Subtotal</span>
                            <span>₹<%= subtotal.toLocaleString() %></span>
                        </div>
                        <div class="summary-row">
                            <span>Shipping</span>
                            <% if(shipping === 0) { %>
                                <span class="green">Free</span>
                            <% } else { %>
                                <span>₹<%= shipping %></span>
                            <% } %>
                        </div>
                        <div class="summary-row">
                            <span>Tax</span>
                            <span>₹<%= tax.toFixed(2) %></span>
                        </div>

                        <div class="divider"></div>

                        <div class="summary-row total">
                            <span>Total</span>
                            <span id="totalAmount">₹<%= total.toFixed(2) %></span>
                        </div>
                        <button type="submit" class="place-order-btn">Place Order</button>
                    </div>

                    <div class="coupons-card">
                        <h3><i class="fa-solid fa-tag"></i> Available Coupons</h3>
                        
                        <% if (coupons && coupons.length > 0) { %>
                            <% coupons.forEach(coupon => { %>
                                <div class="coupon-ticket">
                                    <div class="coupon-info">
                                        <span class="code"><%= coupon.code %></span>
                                        <span class="desc"><%= coupon.description %></span>
                                        <span class="min-order">Min. order: ₹<%= coupon.minPurchase %></span>
                                    </div>
                                    <button type="button" class="copy-btn" onclick="useCoupon('<%= coupon.code %>')">Apply</button>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="no-coupons">
                                <i class="fa-regular fa-face-frown-open"></i>
                                <p>No coupons available</p>
                            </div>
                        <% } %>
                    </div>
                </div>

            </div>
        </form>
    </div>

    <div id="addressModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Add a new address</h3>
            
            <form id="addAddressForm">
                <div class="form-group">
                    <input type="text" name="addressType" placeholder="Address name (e.g. Home, Work)" required>
                </div>
                <div class="form-group">
                    <input type="text" name="name" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="tel" name="phone" placeholder="Phone" required>
                </div>
                <div class="form-group">
                    <input type="text" name="addressLine1" placeholder="Address Line 1" required>
                </div>
                <div class="form-group">
                    <input type="text" name="addressLine2" placeholder="Address Line 2 (Optional)">
                </div>
                <div class="form-row">
                    <div class="form-group half">
                        <input type="text" name="city" placeholder="City" required>
                    </div>
                    <div class="form-group half">
                        <input type="text" name="state" placeholder="State" required>
                    </div>
                </div>
                <div class="form-group">
                    <input type="number" name="pincode" placeholder="Pincode" required>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddressModal()">Cancel</button>
                    <button type="submit" class="btn-save">Save Address</button>
                </div>
            </form>
        </div>
    </div>

<%- include('../partials/footer') %>

<script src="/js/axios.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    // --- Toast Helper ---
    const showToast = (message, type) => {
        const bgColor = type === 'success' ? "linear-gradient(to right, #30E527, #238500)" : "linear-gradient(to right, #e52d27, #b31217)";
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: { background: bgColor, borderRadius: '10px' }
        }).showToast();
    };

   function selectCard(input) {
        const container = input.closest('.address-grid') || input.closest('.payment-options');
        container.querySelectorAll('.selection-card').forEach(card => card.classList.remove('selected'));
        input.closest('.selection-card').classList.add('selected');
    }

    // --- MAIN FORM SUBMIT LISTENER ---
    document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
        e.preventDefault(); 

        // 1. Get Selected Address (Directly from DOM)
        const selectedAddressInput = document.querySelector('input[name="addressId"]:checked');
        const selectedPaymentInput = document.querySelector('input[name="paymentMethod"]:checked');

        // 2. Validate
        if (!selectedAddressInput) {
            return showToast("Please select a delivery address", "error");
        }
        if (!selectedPaymentInput) {
            return showToast("Please select a payment method", "error");
        }

        const addressId = selectedAddressInput.value;
        const paymentMethod = selectedPaymentInput.value;
        const rawAmount = document.getElementById('totalAmount').innerText;
        const totalAmount = parseFloat(rawAmount.replace(/[₹,]/g, '').trim());



        // 3. Route to Handler
        if (paymentMethod === 'Razorpay') {
            await handleRazorpay(totalAmount, addressId);
        } else {
            await handleCodOrWallet(paymentMethod, addressId);
        }
    });

    // --- A. RAZORPAY HANDLER ---
    async function handleRazorpay(amount, addressId) {
        
    

        if (!addressId) {
            return showToast("Address ID missing. Refresh page.", "error");
        }

        try {
            // 1. Create Order on Backend
            const response = await axios.post('/user/create-payment', { amount: amount });
            const orderData = response.data;

            if (!orderData.success) {
                return showToast('Error initiating payment', 'error');
            }

            // 2. Configure Options
            const options = {
                "key": orderData.key_id,
                "amount": orderData.amount,
                "currency": "INR",
                "name": "LapStore",
                "description": "Purchase Payment",
                "order_id": orderData.id,
                
                // --- SUCCESS HANDLER ---
                "handler": async function (response) {
                    try {
                     

                        const verifyResponse = await axios.post('/user/verify-payment', {
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature,
                            addressId: addressId // <--- Sending it here
                        });

                        if (verifyResponse.data.success) {
                            window.location.href = `/user/order-success/${verifyResponse.data.orderId}`;
                        } else {
                            showToast('Payment verification failed!', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showToast("Verification error: " + (err.response?.data?.message || err.message), 'error');
                    }
                },
                "theme": { "color": "#3399cc" },
                "modal": {
                    "ondismiss": function() {
                        showToast('Payment Cancelled', 'error');
                    }
                }
            };

            // 3. Initialize & Open
            const rzp1 = new Razorpay(options);

            rzp1.on('payment.failed', async function (response){
                const errorDesc = response.error.description;
                const rzpOrderId = response.error.metadata.order_id;
                const rzpPaymentId = response.error.metadata.payment_id;

                try {
                    // 1. Save Failed Order to DB
                    await axios.post('/user/payment-failed', {
                        razorpay_order_id: rzpOrderId,
                        razorpay_payment_id: rzpPaymentId,
                        razorpay_error: errorDesc,
                        addressId: addressId
                    });
                } catch (err) {
                    console.error("Could not save failed order", err);
                }

                let failureUrl = `/user/order-failure?error=${encodeURIComponent(errorDesc)}`;
                if(rzpOrderId) failureUrl += `&razorpayOrderId=${rzpOrderId}`;
                if(rzpPaymentId) failureUrl += `&razorpayPaymentId=${rzpPaymentId}`;

                window.location.href = failureUrl;
            });

            rzp1.open();

        } catch (error) {
            console.error("Razorpay Error:", error);
            showToast("Something went wrong with payment", 'error');
        }
    }

    // --- B. COD / WALLET HANDLER ---
    async function handleCodOrWallet(paymentMethod, addressId) {
        try {
            const response = await axios.post('/user/cart/checkout/place-order', {
                addressId: addressId,
                paymentMethod: paymentMethod
            });

            if (response.data.success) {
                window.location.href = `/user/order-success/${response.data.orderId}`;
            } else {
                showToast(response.data.message || "Failed to place order", "error");
            }
        } catch (error) {
            console.error(error);
            showToast(error.response?.data?.message || "Something went wrong", "error");
        }
    }
    // --- C. ADDRESS MODAL LOGIC ---
    const modal = document.getElementById('addressModal');

    function openAddressModal() { modal.classList.add('active'); }
    function closeAddressModal() { modal.classList.remove('active'); }
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeAddressModal();
    });

    document.getElementById('addAddressForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await axios.post('/user/home/manageAddress/add', data);
            if (response.data.success) {
                showToast('New address added success', 'success');
                setTimeout(() => window.location.reload(), 1500);
            } else {
                showToast(response.data.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showToast("Failed to add address", "error");
        }
    });

    // --- D. COUPON LOGIC (Placeholder) ---
    function useCoupon(code) {
        showToast("Coupon functionality coming soon!", "success");
    }
</script>